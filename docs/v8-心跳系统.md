# V8: 心跳系统

> 核心哲学: Agent 需要在"合适的时机"主动检查，而不是永远被动等待。

V8 在 V7 的时间感知基础上新增 `HeartbeatSystem`，把"检查清单 + 检查状态"做成可调用能力。

---

## V7 vs V8

| 维度 | V7 | V8 |
|---|---|---|
| 工具数 | 28 | 33 |
| 新增工具 | - | 5 个 heartbeat 工具 |
| 新文件 | - | `HEARTBEAT.md`, `memory/heartbeat-state.json` |
| 代码规模 | 1372 行 | 1671 行 |

---

## HeartbeatSystem 数据模型

```typescript
interface HeartbeatState {
  lastChecks: Record<string, number>;
  lastHeartbeat: number;
}
```

- 清单文件: `HEARTBEAT.md`
- 状态文件: `memory/heartbeat-state.json`

---

## 5 个 heartbeat 工具（代码实际）

```typescript
heartbeat_get()
heartbeat_update(content)
heartbeat_record(check_name)
heartbeat_status()
heartbeat_run()
```

说明：V8 **没有** `heartbeat_add/check/complete/list` 这组工具。

---

## 核心行为

### 1. `heartbeat_get`

读取 `HEARTBEAT.md`；若不存在返回可理解提示，不抛异常。

### 2. `heartbeat_update`

整体覆盖更新清单内容。

### 3. `heartbeat_record`

记录某个检查项的完成时间到状态文件。

### 4. `heartbeat_status`

输出上次心跳时间 + 各检查项"距今多少分钟"。

### 5. `heartbeat_run`

- 深夜（23:00-08:00）默认静默，返回 `HEARTBEAT_OK (深夜静默)`。
- 若无清单，返回 `HEARTBEAT_OK (无检查清单)`。
- 其余情况返回"请检查 HEARTBEAT.md"的触发消息。

---

## 与 V7 组合后的完整循环

```text
heartbeat -> recall -> identify -> plan -> execute -> track -> remember
```

心跳不替代任务规划，它只负责"是否该检查/提醒"。

---

## 最小验证

```bash
npx tsx v8-agent.ts
```

```text
>> 先写入检查清单
[heartbeat_update] {"content":"# HEARTBEAT\n- [ ] 每日回顾\n- [ ] 跟进未完成事项"}

>> 触发心跳
[heartbeat_run] {}

>> 标记一次检查
[heartbeat_record] {"check_name":"每日回顾"}

>> 查看状态
[heartbeat_status] {}
```

---

## 节流机制

V8 实现了多层节流防止心跳被滥用：

1. **深夜静默**: 23:00-08:00 自动跳过心跳
2. **定时间隔**: 默认 30 分钟执行一次定时心跳
3. **IPC 节流**: 外部触发的心跳请求最小间隔 1 分钟，防止频繁调用

```typescript
const MIN_HEARTBEAT_GAP = 60 * 1000; // 最小心跳间隔 1 分钟

// IPC 处理中
if (now - this.lastHeartbeatTime < MIN_HEARTBEAT_GAP) {
  socket.write("THROTTLED");
  return;
}
```

---

## 演进意义

V8 让 Agent 具备"运行时节律"而不是纯请求驱动，为 V9 的多会话路由提供了主动检查入口。

---

[← V7: 分层记忆](./v7-分层记忆.md) | [V9: 会话管理 →](./v9-会话管理.md)
