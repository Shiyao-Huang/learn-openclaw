# V8: å¿ƒè·³ç³»ç»Ÿ

> **æ ¸å¿ƒå“²å­¦**: "Agent éœ€è¦ä¸»åŠ¨æ€§"

## ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ç³»ç»Ÿï¼Ÿ

V7 çš„ Agent æœ‰äº†æ—¶é—´æ„ŸçŸ¥ï¼Œä½†å®ƒæ˜¯è¢«åŠ¨çš„â€”â€”åªåœ¨ç”¨æˆ·è¯·æ±‚æ—¶æ‰è¡ŒåŠ¨ã€‚é—®é¢˜ï¼š

1. **è¢«åŠ¨å“åº”**: ç”¨æˆ·ä¸é—®ï¼ŒAgent ä¸è¯´
2. **é—å¿˜æé†’**: é‡è¦äº‹é¡¹å®¹æ˜“è¢«é—å¿˜
3. **æ— ä¸»åŠ¨æ€§**: ä¸ä¼šä¸»åŠ¨æ£€æŸ¥å¾…åŠäº‹é¡¹

V8 å¼•å…¥å¿ƒè·³ç³»ç»Ÿï¼š
- **å¾…åŠè¿½è¸ª**: è®°å½•éœ€è¦è·Ÿè¿›çš„äº‹é¡¹
- **ä¸»åŠ¨æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æé†’çš„äº‹
- **åˆ°æœŸæé†’**: è‡ªåŠ¨æé†’å³å°†åˆ°æœŸçš„ä»»åŠ¡

---

## æ ¸å¿ƒè®¾è®¡

### HEARTBEAT.md æ–‡ä»¶

```markdown
# å¿ƒè·³å¾…åŠ

## å¾…å¤„ç†

- [ ] 2024-01-20 | æäº¤ä»£ç å®¡æŸ¥æŠ¥å‘Š
- [ ] 2024-01-18 | è·Ÿè¿›ç”¨æˆ·åé¦ˆ
- [ ] 2024-01-25 | é¡¹ç›®é‡Œç¨‹ç¢‘æ£€æŸ¥

## å·²å®Œæˆ

- [x] 2024-01-15 | å®Œæˆ API æ–‡æ¡£
```

### HeartbeatSystem ç±»

```typescript
interface HeartbeatItem {
  id: string;
  content: string;
  dueDate: string;      // YYYY-MM-DD
  completed: boolean;
  createdAt: string;
}

class HeartbeatSystem {
  private heartbeatFile: string;
  private items: HeartbeatItem[] = [];

  constructor() {
    this.heartbeatFile = path.join(WORKDIR, "HEARTBEAT.md");
    this.load();
  }

  // æ·»åŠ å¾…åŠ
  add(content: string, dueDate: string): string {
    const id = Date.now().toString(36);
    this.items.push({
      id,
      content,
      dueDate,
      completed: false,
      createdAt: new Date().toISOString()
    });
    this.save();
    return `å·²æ·»åŠ å¾…åŠ: ${content} (æˆªæ­¢: ${dueDate})`;
  }

  // æ£€æŸ¥å¾…åŠçŠ¶æ€
  check(): string {
    const today = new Date().toISOString().split("T")[0];
    const pending = this.items.filter(i => !i.completed);

    if (pending.length === 0) return "æ²¡æœ‰å¾…å¤„ç†çš„äº‹é¡¹";

    const overdue = pending.filter(i => i.dueDate < today);
    const dueToday = pending.filter(i => i.dueDate === today);
    const upcoming = pending.filter(i => i.dueDate > today);

    let result = "## å¿ƒè·³æ£€æŸ¥\n\n";

    if (overdue.length > 0) {
      result += "### âš ï¸ å·²è¿‡æœŸ\n";
      overdue.forEach(i => result += `- ${i.content} (æˆªæ­¢: ${i.dueDate})\n`);
      result += "\n";
    }

    if (dueToday.length > 0) {
      result += "### ğŸ”” ä»Šæ—¥åˆ°æœŸ\n";
      dueToday.forEach(i => result += `- ${i.content}\n`);
      result += "\n";
    }

    if (upcoming.length > 0) {
      result += "### ğŸ“… å³å°†åˆ°æœŸ\n";
      upcoming.slice(0, 5).forEach(i => result += `- ${i.content} (${i.dueDate})\n`);
    }

    return result;
  }

  // å®Œæˆå¾…åŠ
  complete(id: string): string {
    const item = this.items.find(i => i.id === id);
    if (!item) return `é”™è¯¯: æœªæ‰¾åˆ°å¾…åŠ ${id}`;
    item.completed = true;
    this.save();
    return `å·²å®Œæˆ: ${item.content}`;
  }

  // åˆ—å‡ºæ‰€æœ‰å¾…åŠ
  list(): string {
    const pending = this.items.filter(i => !i.completed);
    if (pending.length === 0) return "æ²¡æœ‰å¾…å¤„ç†çš„äº‹é¡¹";

    return pending.map(i =>
      `[${i.id}] ${i.content} (æˆªæ­¢: ${i.dueDate})`
    ).join("\n");
  }
}
```

---

## å¿ƒè·³å·¥å…·

### heartbeat_add

```typescript
{
  name: "heartbeat_add",
  description: "æ·»åŠ å¾…åŠäº‹é¡¹",
  input_schema: {
    type: "object",
    properties: {
      content: { type: "string", description: "å¾…åŠå†…å®¹" },
      due_date: { type: "string", description: "æˆªæ­¢æ—¥æœŸ (YYYY-MM-DD)" }
    },
    required: ["content", "due_date"]
  }
}
```

### heartbeat_check

```typescript
{
  name: "heartbeat_check",
  description: "æ£€æŸ¥å¾…åŠçŠ¶æ€ï¼Œè¿”å›è¿‡æœŸã€ä»Šæ—¥åˆ°æœŸã€å³å°†åˆ°æœŸçš„äº‹é¡¹",
  input_schema: { type: "object", properties: {} }
}
```

### heartbeat_complete

```typescript
{
  name: "heartbeat_complete",
  description: "æ ‡è®°å¾…åŠä¸ºå·²å®Œæˆ",
  input_schema: {
    type: "object",
    properties: {
      id: { type: "string", description: "å¾…åŠ ID" }
    },
    required: ["id"]
  }
}
```

### heartbeat_list

```typescript
{
  name: "heartbeat_list",
  description: "åˆ—å‡ºæ‰€æœ‰å¾…å¤„ç†çš„äº‹é¡¹",
  input_schema: { type: "object", properties: {} }
}
```

---

## å·¥ä½œæµç¨‹ç¤ºä¾‹

### æ·»åŠ å¾…åŠ

```
ç”¨æˆ·: æé†’æˆ‘ä¸‹å‘¨ä¸‰æäº¤æŠ¥å‘Š

Agent: [è°ƒç”¨ heartbeat_add]
{ content: "æäº¤æŠ¥å‘Š", due_date: "2024-01-24" }

å·²æ·»åŠ å¾…åŠ: æäº¤æŠ¥å‘Š (æˆªæ­¢: 2024-01-24)
```

### ä¸»åŠ¨æ£€æŸ¥

```
ç”¨æˆ·: æœ‰ä»€ä¹ˆéœ€è¦æˆ‘å¤„ç†çš„å—ï¼Ÿ

Agent: [è°ƒç”¨ heartbeat_check]

## ï¿½ï¿½è·³æ£€æŸ¥

### âš ï¸ å·²è¿‡æœŸ
- å›å¤å®¢æˆ·é‚®ä»¶ (æˆªæ­¢: 2024-01-18)

### ğŸ”” ä»Šæ—¥åˆ°æœŸ
- ä»£ç å®¡æŸ¥

### ğŸ“… å³å°†åˆ°æœŸ
- æäº¤æŠ¥å‘Š (2024-01-24)
- é¡¹ç›®æ¼”ç¤º (2024-01-26)
```

### å®Œæˆå¾…åŠ

```
ç”¨æˆ·: ä»£ç å®¡æŸ¥å®Œæˆäº†

Agent: [è°ƒç”¨ heartbeat_list]
[abc123] ä»£ç å®¡æŸ¥ (æˆªæ­¢: 2024-01-20)
[def456] æäº¤æŠ¥å‘Š (æˆªæ­¢: 2024-01-24)

Agent: [è°ƒç”¨ heartbeat_complete]
{ id: "abc123" }

å·²å®Œæˆ: ä»£ç å®¡æŸ¥
```

---

## ä¸»åŠ¨æé†’æœºåˆ¶

V8 å¯ä»¥åœ¨ä¼šè¯å¼€å§‹æ—¶è‡ªåŠ¨æ£€æŸ¥å¿ƒè·³ï¼š

```typescript
// ä¼šè¯å¼€å§‹æ—¶çš„ä¸»åŠ¨æ£€æŸ¥
async function startSession() {
  const checkResult = heartbeatSystem.check();

  // å¦‚æœæœ‰è¿‡æœŸæˆ–ä»Šæ—¥åˆ°æœŸçš„äº‹é¡¹ï¼Œä¸»åŠ¨æé†’
  if (checkResult.includes("å·²è¿‡æœŸ") || checkResult.includes("ä»Šæ—¥åˆ°æœŸ")) {
    console.log("\nğŸ“¢ å¿ƒè·³æé†’:\n");
    console.log(checkResult);
    console.log("\n");
  }
}
```

---

## æ–‡ä»¶ç»“æ„

```
project/
â”œâ”€â”€ HEARTBEAT.md         # å¿ƒè·³å¾…åŠæ–‡ä»¶
â”œâ”€â”€ memory/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ MEMORY.md
â””â”€â”€ ...
```

### HEARTBEAT.md ç¤ºä¾‹

```markdown
# å¿ƒè·³å¾…åŠ

## å¾…å¤„ç†

- [ ] abc123 | 2024-01-24 | æäº¤æŠ¥å‘Š
- [ ] def456 | 2024-01-26 | é¡¹ç›®æ¼”ç¤º
- [ ] ghi789 | 2024-01-30 | å­£åº¦æ€»ç»“

## å·²å®Œæˆ

- [x] xyz000 | 2024-01-20 | ä»£ç å®¡æŸ¥
- [x] uvw111 | 2024-01-18 | å›å¤å®¢æˆ·é‚®ä»¶
```

---

## ç³»ç»Ÿæç¤ºçš„å˜åŒ–

V8 çš„ç³»ç»Ÿæç¤ºåŒ…å«å¿ƒè·³çŠ¶æ€ï¼š

```typescript
const SYSTEM = `${identitySystem.getSystemPrompt()}

ä½ æ˜¯ OpenClaw V8 - æœ‰ä¸»åŠ¨æ€§çš„ Agentã€‚

${layeredMemory.getTimeContext()}

å¿ƒè·³è§„åˆ™:
- ç”¨ heartbeat_add æ·»åŠ éœ€è¦è·Ÿè¿›çš„äº‹é¡¹
- ç”¨ heartbeat_check æ£€æŸ¥å¾…åŠçŠ¶æ€
- ä¸»åŠ¨æé†’ç”¨æˆ·è¿‡æœŸå’Œå³å°†åˆ°æœŸçš„äº‹é¡¹
- å®Œæˆåç”¨ heartbeat_complete æ ‡è®°

å½“å‰å¿ƒè·³çŠ¶æ€:
${heartbeatSystem.check()}

...å…¶ä»–è§„åˆ™...`;
```

---

## ä¸ V7 çš„å¯¹æ¯”

| ç‰¹æ€§ | V7 | V8 |
|------|----|----|
| åˆ†å±‚è®°å¿† | âœ… | âœ… |
| å¾…åŠè¿½è¸ª | âŒ | âœ… HEARTBEAT.md |
| ä¸»åŠ¨æé†’ | âŒ | âœ… è¿‡æœŸ/åˆ°æœŸæé†’ |
| æˆªæ­¢æ—¥æœŸ | âŒ | âœ… æ”¯æŒ due_date |

---

## å…³é”®æ´å¯Ÿ

1. **ä¸»åŠ¨æ€§**: Agent ä¸åº”åªæ˜¯è¢«åŠ¨å“åº”
2. **æ—¶é—´æ•æ„Ÿ**: å¾…åŠäº‹é¡¹éœ€è¦æˆªæ­¢æ—¥æœŸ
3. **çŠ¶æ€å¯è§**: å¿ƒè·³çŠ¶æ€åº”è¯¥å¯¹ç”¨æˆ·å¯è§
4. **è‡ªåŠ¨æé†’**: è¿‡æœŸäº‹é¡¹åº”ä¸»åŠ¨æé†’

---

## ä¸‹ä¸€æ­¥

V8 çš„ Agent æœ‰äº†ä¸»åŠ¨æ€§ï¼Œä½†æ‰€æœ‰å·¥ä½œéƒ½åœ¨åŒä¸€ä¸ªä¼šè¯ä¸­ã€‚V9 å°†å¼•å…¥ä¼šè¯ç®¡ç†ï¼Œè®© Agent èƒ½å¤„ç†å¤šä¸ªç‹¬ç«‹çš„ä»»åŠ¡ä¸Šä¸‹æ–‡ã€‚
