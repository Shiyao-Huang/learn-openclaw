# V13.5: 上下文压缩系统

> 记住重要的，压缩冗余的

## 设计理念

V13.5 引入 Context Compression 系统，解决长对话的 token 消耗问题：
1. 滑动窗口 - 保留最近 N 轮完整对话
2. 智能摘要 - 旧对话压缩成摘要
3. 工具截断 - 长输出自动截断
4. 重要性评分 - 按优先级保留内容

## 核心架构

### 压缩配置

```typescript
interface CompressionConfig {
  maxTurns: number;           // 最大保留轮数 (默认 50)
  keepRecent: number;         // 完整保留最近 N 轮 (���认 10)
  maxToolOutput: number;      // 工具输出最大字符数 (默认 3000)
  summaryMaxChars: number;    // 摘要最大字符数 (默认 500)
  autoCompress: boolean;      // 是否自动压缩 (默认 true)
  importanceThreshold: number; // 重要性阈值 (默认 0.3)
}
```

### 重要性评分

```typescript
interface MessageImportance {
  score: number;              // 0-1
  reasons: string[];
}

// 评分规则:
// - 用户消息: +0.2
// - 包含重要关键词: +0.2
// - 包含代码/命令: +0.1
// - 工具结果: -0.2
// - 内容过短: -0.1
// - 内容丰富: +0.1
```

### 上下文摘要

```typescript
interface ContextSummary {
  timestamp: number;
  turnRange: [number, number];
  content: string;
  keyPoints: string[];
}
```

## 工具列表

| 工具 | 描述 |
|------|------|
| `context_status` | 查看上下文压缩状态和配置 |
| `context_compress` | 手动触发上下文压缩 |
| `context_config` | 配置压缩参数 |
| `context_summary` | 查看历史摘要 |

## 压缩流程

```
新消息到达
    ↓
检查历史长度
    ↓ (> keepRecent * 2)
分离消息: [要压缩] + [要保留]
    ↓
评估重要性
    ↓
生成摘要
    ↓
构建压缩后历史:
  [摘要] + [重要消息] + [最近消息]
```

## 使用示例

### 查看状态

```typescript
context_status()
// 返回:
// ## 上下文压缩状态
// **配置**
// - 最大轮数: 50
// - 保留最近: 10 轮
// - 工具输出限制: 3000 字符
// - 自动压缩: 开启
// **统计**
// - 总消息数: 45
// - 已压缩: 20 条
// - 节省 token: ~5000
```

### 手动压缩

```typescript
context_compress()
// 返回: "压缩完成: 45 → 25 条消息 (减少 20 条)"
```

### 配置参数

```typescript
context_config({ keepRecent: 15, maxToolOutput: 5000 })
// 返回: "配置已更新"
```

### 查看摘要

```typescript
context_summary({ limit: 3 })
// 返回最近 3 条历史摘要
```

## 配置持久化

压缩数据保存在 `.compression/` 目录：
- `config.json` - 压缩配置
- `summaries.json` - 历史摘要

## 自动压缩触发

在 `chat()` 函数开始时自动检查并压缩：

```typescript
async function chat(prompt: string, history: MessageParam[] = []) {
  history.push({ role: "user", content: prompt });
  
  // 自动压缩
  const compressed = contextCompressor.compress(history);
  if (compressed.length < history.length) {
    history.length = 0;
    history.push(...compressed);
  }
  
  // ... 继续处理
}
```

## 工具输出截断

所有工具输出自动截断：

```typescript
// 在工具执行后
output = contextCompressor.truncateToolOutput(output);
```

截断格式：
```
[前半部分内容]

... [截断 X 字符] ...

[后半部分内容]
```

## 与现有系统集成

### V10 内省系统
- 压缩操作也被记录到内省日志
- 可分析压缩效果

### V13 进化系统
- 可基于压缩统计生成优化建议
- 自动调整压缩参数

## 下一步

V14 可能的方向：
- 插件系统 - 动态加载外部能力
- LLM 摘要 - 使用模型生成更智能的摘要
- 语义压缩 - 基于语义相似度合并消息

---

*Created: 2026-02-10*
*Lines: ~300*
