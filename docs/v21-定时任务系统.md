# V21: 定时任务与提醒系统

## 概述

V21 引入完整的定时任务调度系统，支持类 Cron 的定时任务和一次性提醒功能。

## 新增工具

### 定时任务工具 (6个)

| 工具 | 描述 |
|------|------|
| `cron_create` | 创建定时任务 |
| `cron_list` | 列出所有任务 |
| `cron_update` | 更新任务配置 |
| `cron_remove` | 删除任务 |
| `cron_run` | 立即执行任务 |
| `cron_runs` | 查看任务执行历史 |

### 提醒工具 (3个)

| 工具 | 描述 |
|------|------|
| `reminder_set` | 设置提醒 |
| `reminder_list` | 列出提醒 |
| `reminder_cancel` | 取消提醒 |

## 调度类型

### 1. 一次性调度 (at)

```json
{
  "kind": "at",
  "at": "2026-02-12T10:00:00Z"
}
```

### 2. 周期性调度 (every)

```json
{
  "kind": "every",
  "everyMs": 3600000
}
```

### 3. Cron 表达式

```json
{
  "kind": "cron",
  "expr": "0 9 * * *",
  "tz": "Asia/Shanghai"
}
```

## 使用示例

### 创建每小时检查任务

```
使用 cron_create 创建任务:
{
  "name": "每小时健康检查",
  "schedule": {
    "kind": "every",
    "everyMs": 3600000
  },
  "payload": {
    "kind": "systemEvent",
    "text": "执行系统健康检查"
  },
  "sessionTarget": "isolated"
}
```

### 设置每日提醒

```
使用 reminder_set 设置提醒:
{
  "text": "该喝水了！",
  "triggerAt": "2026-02-12T09:00:00Z",
  "channel": "console"
}
```

### 创建 Cron 定时任务

```
使用 cron_create 创建每天9点的任务:
{
  "name": "晨会提醒",
  "schedule": {
    "kind": "cron",
    "expr": "0 9 * * 1-5",
    "tz": "Asia/Shanghai"
  },
  "payload": {
    "kind": "systemEvent",
    "text": "工作日晨会时间到了"
  },
  "sessionTarget": "main"
}
```

## 技术实现

### 核心组件

```
v21-agent/cron/
├── types.ts     # 类型定义
├── schedule.ts  # 调度解析
├── manager.ts   # 任务管理器
├── tools.ts     # 工具定义
├── handlers.ts  # 工具处理器
└── index.ts     # 模块入口
```

### 存储

任务数据存储在 `.cron/store.json`:

```json
{
  "jobs": { "job-id": { ... } },
  "reminders": { "rem-id": { ... } },
  "runLogs": { "job-id": [ ... ] }
}
```

### 调度检查

- 每 5 秒检查一次待执行任务
- 支持秒级精度的提醒
- 自动禁用已过期的一次性任务

## 继承关系

V21 继承 V11-V20 全部能力:
- V11: 基础模块化架构
- V12: 安全策略系统
- V13: 自进化系统
- V14: 插件系统
- V15: 多模型协作
- V16: 工作流引擎
- V17: 外部集成
- V18: 团队协作
- V19: 持久化与恢复
- V20: 浏览器自动化
- **V21: 定时任务与提醒系统** ⭐

## 代码统计

- v21-agent/cron/: 5 个模块, ~2800 行
- 测试: tests/v21-cron.test.ts (计划中)

## 下一步

- V22: 代码执行沙箱 (Python/JavaScript)
