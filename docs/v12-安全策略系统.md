# V12: 安全策略系统

> 信任但验证 - 建立完整的安全边界和审计机制

## 设计理念

V12 引入 Security 系统，实现：
1. 工具权限分级管理
2. 上下文感知的安全策略
3. 完整的审计日志
4. 敏感数据自动保护

## 核心架构

### 工具风险等级

```typescript
type ToolRiskLevel = 'safe' | 'confirm' | 'dangerous';

// Safe: 只读操作，无副作用
// Confirm: 写操作，需要记录
// Dangerous: 系统操作，需要确认
```

### 安全上下文

```typescript
interface SecurityContext {
  userId?: string;
  channel?: string;
  chatType?: 'direct' | 'group';
  trustLevel: TrustLevel;  // owner | trusted | normal | restricted
}
```

### 安全策略

```typescript
interface SecurityPolicy {
  // 工具风险分类
  toolRiskLevels: Record<string, ToolRiskLevel>;
  // 信任等级对应的允许风险
  trustAllowedRisk: Record<TrustLevel, ToolRiskLevel[]>;
  // 群聊中禁用的工具
  groupDenyList: string[];
  // 敏感数据模式
  sensitivePatterns: RegExp[];
  // 是否启用审计
  auditEnabled: boolean;
  // 是否需要确认危险操作
  confirmDangerous: boolean;
}
```

### 审计日志

```typescript
interface AuditLogEntry {
  timestamp: number;
  tool: string;
  args: Record<string, any>;
  riskLevel: ToolRiskLevel;
  userId?: string;
  channel?: string;
  chatType?: 'direct' | 'group';
  decision: 'allowed' | 'denied' | 'confirmed';
  reason?: string;
}
```

## 工具列表

| 工具 | 描述 |
|------|------|
| `security_check` | 检查操作是否被允许 |
| `security_audit` | 查看审计日志 |
| `security_policy` | 查看/更新安全策略 |
| `security_mask` | 遮蔽敏感信息 |
| `security_context` | 设置安全上下文（测试用） |

## 默认策略

### 工具风险分类

**Safe (21个)**: 只读操作
- read_file, grep, memory_search, memory_get, memory_stats
- identity_get, daily_read, daily_recent, daily_list
- longterm_read, time_context, heartbeat_get, heartbeat_status
- session_list, introspect_stats, introspect_patterns, introspect_logs
- channel_list, channel_status, security_audit, security_policy

**Confirm (19个)**: 写操作
- write_file, edit_file, memory_append, memory_ingest
- identity_update, daily_write, longterm_update, longterm_append
- heartbeat_update, heartbeat_record, session_create, session_delete
- channel_send, channel_config, channel_start, channel_stop
- TodoWrite, Claw, subagent

**Dangerous (5个)**: 系统操���
- bash, identity_init, session_cleanup, heartbeat_run, introspect_reflect

### 信任等级权限

| 等级 | 允许的风险级别 |
|------|----------------|
| owner | safe, confirm, dangerous |
| trusted | safe, confirm |
| normal | safe |
| restricted | (无) |

### 群聊禁用工具

- bash
- write_file
- edit_file
- identity_update
- identity_init
- session_cleanup
- longterm_update

## 敏感数据保护

自动识别并遮蔽以下模式：
- API key / Secret / Token / Password
- Private key / Credential
- Base64 长字符串
- OpenAI API key (sk-...)
- GitHub token (ghp_...)

## 使用示例

### 检查权限

```typescript
// 检查 bash 命令是否允许
security_check({ tool: "bash", args: { command: "ls" } })
// 结果: ✗ 操作拒绝: 信任等级 normal 不允许���行 dangerous 级别的操作
```

### 查看审计日志

```typescript
security_audit({ days: 7, limit: 50 })
// 返回最近 7 天的审计日志
```

### 遮蔽敏感信息

```typescript
security_mask({ text: "API_KEY=sk-abc123xyz" })
// 结果: API_KEY=[REDACTED]
```

## 配置持久化

安全策略保存在 `.security/policy.json`
审计日志保存在 `.security/audit/audit_YYYY-MM-DD.jsonl`

## 与现有系统集成

### V11 Channel 系统
- 根据渠道类型调整安全策略
- 群聊自动应用更严格的限制

### V10 内省系统
- 安全操作也被记录到内省日志
- 可分析安全相关的行为模式

## 下一步

V13 将实现自进化系统：
- 基于内省数据自动优化行为
- 学习用户偏好调整策略
- 自动修复常见问题

---

*Created: 2026-02-10*
*Lines: ~2766*
