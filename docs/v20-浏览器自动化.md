# V20: 浏览器自动化

> OpenClaw V20 引入了完整的浏览器自动化能力，让 Agent 能够控制真实浏览器、与网页交互、抓取内容。

---

## 概述

V20 实现了基于 CDP (Chrome DevTools Protocol) 的浏览器自动化系统，Agent 可以：

- 启动和控制 Chrome/Chromium/Edge 浏览器
- 导航到任意网页
- 获取页面内容和结构
- 截取网页截图
- 点击元素、输入文本
- 执行 JavaScript 代码

---

## 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    V20-Agent                            │
├─────────────────────────────────────────────────────────┤
│  BrowserController                                      │
│  ├── Chrome Process Management                          │
│  ├── CDP WebSocket Connection                           │
│  └── Session Lifecycle                                  │
├─────────────────────────────────────────────────────────┤
│  Browser Tools (9)                                      │
│  ├── browser_start/stop                                 │
│  ├── browser_navigate                                   │
│  ├── browser_snapshot                                   │
│  ├── browser_screenshot                                 │
│  ├── browser_click/type                                 │
│  ├── browser_evaluate                                   │
│  └── browser_list                                       │
└─────────────────────────────────────────────────────────┘
                           │
                    WebSocket (CDP)
                           │
┌─────────────────────────────────────────────────────────┐
│              Chrome / Chromium / Edge                   │
│         (Remote Debugging Protocol)                     │
└─────────────────────────────────────────────────────────┘
```

---

## 核心组件

### BrowserController

控制器管理浏览器生命周期：

```typescript
class BrowserController {
  async start(config?: BrowserConfig): Promise<BrowserSession>
  async stop(sessionId: string): Promise<boolean>
  async navigate(sessionId: string, url: string, options?: NavigationOptions)
  async getSnapshot(sessionId: string): Promise<PageSnapshot>
  async screenshot(sessionId: string, options?: ScreenshotOptions): Promise<Buffer>
  async click(sessionId: string, selector: string)
  async type(sessionId: string, selector: string, text: string)
  async evaluate(sessionId: string, script: string): Promise<any>
  listSessions(): BrowserSession[]
  async cleanup(): Promise<void>
}
```

### 浏览器配置

```typescript
interface BrowserConfig {
  headless?: boolean;           // 无头模式（默认 true）
  viewport?: { width: number; height: number };
  userDataDir?: string;         // 用户数据目录
  args?: string[];              // 额外启动参数
}
```

### 页面快照

```typescript
interface PageSnapshot {
  url: string;
  title: string;
  text: string;                 // 页面纯文本内容
  elements: PageElement[];      // 可交互元素列表
  timestamp: number;
}

interface PageElement {
  tag: string;
  text?: string;
  attributes: Record<string, string>;
  rect?: DOMRect;               // 元素位置和大小
}
```

---

## 工具详解

### browser_start

启动一个新的浏览器实例。

```typescript
{
  name: "browser_start",
  parameters: {
    headless?: boolean;         // 默认 true
    viewport?: { width: number; height: number };
  },
  returns: {
    sessionId: string;
    status: "ready";
    cdpPort: number;
  }
}
```

**示例**:
```json
{
  "headless": false,
  "viewport": { "width": 1280, "height": 720 }
}
```

### browser_navigate

导航到指定 URL。

```typescript
{
  name: "browser_navigate",
  parameters: {
    sessionId: string;
    url: string;
    waitUntil?: "load" | "domcontentloaded" | "networkidle";
  }
}
```

### browser_snapshot

获取页面快照，包括标题、文本内容和可交互元素。

```typescript
{
  name: "browser_snapshot",
  parameters: { sessionId: string },
  returns: {
    url: string;
    title: string;
    text: string;
    elements: PageElement[];
  }
}
```

### browser_screenshot

截取页面截图。

```typescript
{
  name: "browser_screenshot",
  parameters: {
    sessionId: string;
    fullPage?: boolean;         // 截取完整页面
    format?: "png" | "jpeg";    // 默认 png
    quality?: number;           // jpeg 质量 (0-100)
  },
  returns: "截图文件路径"
}
```

### browser_click / browser_type

页面交互工具。

```typescript
{
  name: "browser_click",
  parameters: {
    sessionId: string;
    selector: string;           // CSS 选择器
  }
}

{
  name: "browser_type",
  parameters: {
    sessionId: string;
    selector: string;
    text: string;
  }
}
```

### browser_evaluate

在页面中执行 JavaScript 代码。

```typescript
{
  name: "browser_evaluate",
  parameters: {
    sessionId: string;
    script: string;
  },
  returns: any  // JS 执行结果
}
```

---

## 使用示例

### 基本网页抓取

```typescript
// 1. 启动浏览器
const session = await controller.start({ headless: true });

// 2. 导航到目标页面
await controller.navigate(session.id, "https://example.com");

// 3. 获取页面内容
const snapshot = await controller.getSnapshot(session.id);
console.log(snapshot.title);
console.log(snapshot.text);

// 4. 清理
await controller.stop(session.id);
```

### 截图保存

```typescript
// 截取完整页面
await controller.navigate(session.id, "https://example.com");
const buffer = await controller.screenshot(session.id, { 
  fullPage: true,
  format: "png" 
});
fs.writeFileSync("screenshot.png", buffer);
```

### 表单交互

```typescript
// 导航到登录页
await controller.navigate(session.id, "https://example.com/login");

// 填写表单
await controller.type(session.id, "input[name='username']", "myuser");
await controller.type(session.id, "input[name='password']", "mypass");

// 点击登录按钮
await controller.click(session.id, "button[type='submit']");

// 等待页面加载并获取结果
await new Promise(r => setTimeout(r, 2000));
const snapshot = await controller.getSnapshot(session.id);
```

### 执行 JavaScript

```typescript
// 获取页面特定数据
const data = await controller.evaluate(session.id, `
  (function() {
    const items = document.querySelectorAll('.item');
    return Array.from(items).map(el => ({
      title: el.querySelector('.title')?.innerText,
      price: el.querySelector('.price')?.innerText
    }));
  })()
`);
console.log(data);
```

---

## 环境配置

### Chrome 路径

自动检测以下路径：

**macOS**:
- `/Applications/Google Chrome.app/Contents/MacOS/Google Chrome`
- `/Applications/Chromium.app/Contents/MacOS/Chromium`
- `/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge`

**Linux**:
- `/usr/bin/google-chrome`
- `/usr/bin/chromium`
- `/usr/bin/microsoft-edge`

**Windows**:
- `C:\Program Files\Google\Chrome\Application\chrome.exe`

**环境变量覆盖**:
```bash
export CHROME_PATH=/path/to/chrome
```

### 依赖

```json
{
  "dependencies": {
    "ws": "^8.x"  // WebSocket 客户端
  }
}
```

---

## CDP 协议说明

Chrome DevTools Protocol 是 Chrome 提供的远程调试协议，基于 WebSocket 通信。

### 核心域

- **Page**: 页面导航、截图、事件
- **Runtime**: JavaScript 执行
- **DOM**: 文档结构查询
- **Network**: 网络请求监控

### 请求格式

```json
{
  "id": 1,
  "method": "Page.navigate",
  "params": { "url": "https://example.com" }
}
```

### 响应格式

```json
{
  "id": 1,
  "result": { "frameId": "12345", "loaderId": "67890" }
}
```

---

## 安全考虑

1. **本地访问**: CDP 只监听本地端口 (127.0.0.1)
2. **临时用户数据**: 每个会话使用独立的数据目录
3. **资源清理**: 会话结束时自动清理进程和临时文件
4. **超时控制**: 所有操作都有超时机制

---

## 错误处理

常见错误及解决方案：

| 错误 | 原因 | 解决 |
|------|------|------|
| Chrome not found | 未安装 Chrome | 安装 Chrome 或设置 CHROME_PATH |
| CDP timeout | 浏览器启动慢 | 增加超时时间或检查系统资源 |
| Session not found | 会话已关闭 | 检查 sessionId 是否正确 |
| Navigation failed | 网络问题 | 检查 URL 和网络连接 |

---

## 测试

```bash
# 运行 V20 浏览器测试
npm test -- tests/v20-browser.test.ts
```

测试需要本地安装 Chrome/Chromium，否则会跳过。

---

## 与 OpenClaw 原生 Browser 对比

| 特性 | V20 Browser | OpenClaw Browser |
|------|-------------|------------------|
| 协议 | CDP | CDP |
| 无头模式 | ✅ | ✅ |
| 有头模式 | ✅ | ✅ |
| 截图 | ✅ | ✅ |
| PDF 生成 | ❌ | ✅ |
| 多标签页 | ❌ | ✅ |
| 节点选择器 | CSS | ARIA/Role |
| 代理支持 | ❌ | ✅ |

V20 实现了核心浏览器能力，OpenClaw 原生版本功能更全面。

---

## 代码统计

- `v20-agent/browser/`: 5 个文件
- 总代码量: ~1200 行
- 工具数: 9 个
- 测试数: 7 个

---

## 总结

V20 浏览器自动化系统提供了完整的网页控制能力：

- ✅ 启动/停止浏览器实例
- ✅ 页面导航和内容获取
- ✅ 截图和快照功能
- ✅ 元素交互（点击、输入）
- ✅ JavaScript 执行
- ✅ 多会话管理

这是 Agent 与外部 Web 世界交互的重要能力，为自动化任务、数据抓取、网页测试等场景提供支持。

---

*Last updated: 2026-02-12*
