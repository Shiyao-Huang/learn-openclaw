# V17: 外部集成系统

> 让 Agent 与外部世界无缝连接

## 概述

V17 引入外部集成系统，允许 Agent 接收外部事件、提供 API 端点、与第三方服务深度集成。这是从"封闭系统"到"开放平台"的转变。

## 核心能力

### 1. Webhook 接收器

接收外部服务的 HTTP 回调:

```typescript
// 注册 webhook 端点
await tools.webhook_register({
  path: '/github/push',
  method: 'POST',
  handler: 'handleGitHubPush',
  secret: 'github_webhook_secret'
});

// 处理函数
async function handleGitHubPush(payload: any) {
  const { repository, commits } = payload;
  await tools.daily_write({
    content: `收到 ${repository.name} 推送: ${commits.length} 个提交`
  });
  return { ok: true };
}
```

支持的特性:
- 自定义路径和 HTTP 方法
- 签名验证 (HMAC)
- 速率限制
- 自动重试机制

### 2. REST API 端点

提供标准化的 REST API:

```typescript
// 查询 Agent 状态
GET /api/v1/status
→ { status: 'idle', currentTask: null, uptime: 3600 }

// 发送消息
POST /api/v1/message
{ "message": "记住明天有会议" }
→ { "id": "msg_123", "status": "processing" }

// 获取任务状态
GET /api/v1/tasks/:id
→ { "id": "msg_123", "status": "completed", "result": "..." }
```

### 3. 事件总线

内部事件系统，支持 pub/sub:

```typescript
// 订阅事件
await tools.event_subscribe({
  topic: 'memory.updated',
  handler: 'syncToNotion'
});

// 发布事件
await tools.event_publish({
  topic: 'task.completed',
  payload: { taskId: '123', result: '...' }
});
```

内置事件类型:
- `memory.updated` - 记忆更新
- `session.started/ended` - 会话开始/结束
- `task.completed/failed` - 任务完成/失败
- `channel.message` - 收到渠道消息
- `cron.triggered` - 定时任务触发

### 4. MCP 协议支持

Model Context Protocol (MCP) 集成:

```typescript
// 连接 MCP 服务器
await tools.mcp_connect({
  name: 'filesystem',
  transport: 'stdio',
  command: 'npx',
  args: ['-y', '@modelcontextprotocol/server-filesystem', '/path/to/allowed']
});

// 使用 MCP 工具
const result = await tools.mcp_call({
  server: 'filesystem',
  tool: 'read_file',
  args: { path: '/allowed/file.txt' }
});
```

## 工具列表

| 工具 | 描述 |
|------|------|
| `webhook_register` | 注册 webhook 端点 |
| `webhook_list` | 列出所有 webhook |
| `webhook_delete` | 删除 webhook |
| `api_start` | 启动 REST API 服务器 |
| `api_stop` | 停止 API 服务器 |
| `api_status` | 查看 API 状态 |
| `event_subscribe` | 订阅事件 |
| `event_unsubscribe` | 取消订阅 |
| `event_publish` | 发布事件 |
| `event_list` | 列出订阅 |
| `mcp_connect` | 连接 MCP 服务器 |
| `mcp_disconnect` | 断开 MCP 连接 |
| `mcp_list` | 列出 MCP 连接 |
| `mcp_call` | 调用 MCP 工具 |

## 架构

```
v17-agent/
├── external/
│   ├── webhook.ts      # Webhook 管理
│   ├── api.ts          # REST API 服务器
│   ├── events.ts       # 事件总线
│   └── mcp.ts          # MCP 客户端
└── index.ts            # 主入口
```

## 使用示例

### 集成 GitHub Webhook

```typescript
// 创建 webhook 处理器文件
await tools.write_file({
  path: 'handlers/github.ts',
  content: `
export async function handlePush(payload: any) {
  const branch = payload.ref.replace('refs/heads/', '');
  if (branch === 'main') {
    await tools.channel_send({
      channel: 'telegram',
      target: 'my_chat',
      message: '🚀 主分支有新推送！'
    });
  }
  return { processed: true };
}
`
});

// 注册 webhook
await tools.webhook_register({
  path: '/github/push',
  method: 'POST',
  handler: 'handlers/github.ts:handlePush',
  secret: process.env.GITHUB_SECRET
});
```

### REST API 使用

```typescript
// 启动 API
await tools.api_start({ port: 3000 });

// 外部请求:
// curl -X POST http://localhost:3000/api/v1/message \
//   -H "Authorization: Bearer TOKEN" \
//   -d '{"message":"查询今天的日程"}'
```

### 事件驱动

```typescript
// 自动同步记忆到外部系统
await tools.event_subscribe({
  topic: 'memory.updated',
  handler: async (payload) => {
    await tools.web_fetch({
      url: 'https://notion.so/api/v1/pages',
      method: 'POST',
      body: { content: payload.content }
    });
  }
});
```

## 安全考虑

1. **认证**: API 密钥、JWT token
2. **授权**: 基于角色的访问控制
3. **速率限制**: 防止滥用
4. **输入验证**: 严格的 schema 验证
5. **审计日志**: 记录所有外部请求

## 与 OpenClaw 的对比

| 特性 | learn-openclaw V17 | OpenClaw |
|------|-------------------|----------|
| Webhook | 内置简单实现 | 通过 ACP 协议 |
| REST API | 轻量级 HTTP 服务 | Gateway 服务 |
| MCP | 基础客户端 | 完整 ACP 实现 |
| 事件系统 | 内存 + 文件 | 消息队列 |

## 下一步

V18 计划：团队协作
- 多 Agent 协作
- Agent 发现协议
- 任务分配和协调

---

*设计文档 - 2026-02-11*
