# V25: 语音识别 (STT)

> 让 Agent 能够将语音转换为文字

## 概述

V25 在 V24 (语音能力/TTS) 基础上增加了语音识别能力，让 Agent 能够：

- 将音频文件转换为文字
- 支持多种音频格式
- 支持多种语言识别
- 支持时间戳输出
- 记录转录历史

## 架构

```
v25-agent/
├── index.ts          # 主入口，继承 V24
├── stt/              # 语音识别模块
│   ├── index.ts      # 模块入口
│   ├── types.ts      # 类型定义
│   ├── stt.ts        # STT 引擎
│   ├── tools.ts      # 工具定义
│   └── handlers.ts   # 处理器
└── speech/           # 语音管理模块
    ├── types.ts      # 类型定义
    ├── local.ts      # 本地引擎
    ├── api.ts        # API 引擎
    └── manager.ts    # 管理器
```

## 支持的 STT 引擎

### 1. OpenAI Whisper API (云端)

- **模型**: whisper-1
- **优点**: 最高准确率，无需本地资源
- **缺点**: 需要 API Key，有费用
- **配置**: 设置 `OPENAI_API_KEY` 环境变量

### 2. 本地 Whisper (离线)

- **模型**: tiny, base, small, medium, large, turbo
- **优点**: 免费、离线、隐私保护
- **缺点**: 需要本地计算资源
- **安装**: `pip install openai-whisper`

| 模型 | 大小 | 速度 | 准确率 |
|------|------|------|--------|
| tiny | 39M | ~32x | 较低 |
| base | 74M | ~28x | 一般 |
| small | 244M | ~15x | 较好 |
| medium | 769M | ~7x | 高 |
| large | 1550M | ~3x | 最高 |
| turbo | 809M | ~8x | 高 (优化版) |

## 工具列表

### 1. stt_transcribe

将音频转换为文字。

**参数**:
- `source` (必填): 音频源 (本地路径/URL/base64)
- `source_type` (必填): 源类型 (file/url/base64)
- `language` (可选): 语言代码 (zh/en/ja 等)
- `provider` (可选): 提供商 (openai/local/auto)
- `model` (可选): 模型名称
- `enable_timestamps` (可选): 是否返回时间戳

**示例**:
```json
{
  "source": "/path/to/audio.mp3",
  "source_type": "file",
  "language": "zh",
  "provider": "auto"
}
```

### 2. stt_list_models

获取可用的 STT 模型列表。

**参数**:
- `provider` (可选): 筛选提供商 (openai/local/all)

### 3. stt_history

获取 STT 转录历史记录。

**参数**:
- `limit` (可选): 返回记录数，默认 20

### 4. stt_supported_formats

获取支持的音频格式列表。

**返回**: mp3, mp4, mpeg, mpga, m4a, wav, webm, ogg, flac, aac

### 5. stt_clear_history

清除 STT 历史记录。

## 支持的音频格式

- mp3 (MPEG Audio Layer 3)
- mp4 (MPEG-4 Audio)
- mpeg (MPEG Audio)
- mpga (MPEG Audio)
- m4a (MPEG-4 Audio)
- wav (Waveform Audio)
- webm (WebM Audio)
- ogg (Ogg Vorbis)
- flac (Free Lossless Audio Codec)
- aac (Advanced Audio Coding)

## 使用场景

1. **会议记录**: 将会议录音转换为文字
2. **视频字幕**: 从视频提取音频并生成字幕
3. **语音笔记**: 将语音消息转为文字笔记
4. **电话录音**: 转录电话录音内容
5. **播客转录**: 将播客转为可搜索的文字

## 代码示例

### 基础使用

```typescript
import { STTEngine } from "./v25-agent/stt/index.js";

const engine = new STTEngine({
  provider: "auto",
  tempDir: "./temp",
});

// 转录音频
const result = await engine.transcribe({
  source: "/path/to/audio.mp3",
  source_type: "file",
  language: "zh",
});

console.log(result.text);
```

### 使用时间戳

```typescript
const result = await engine.transcribe({
  source: "/path/to/audio.mp3",
  source_type: "file",
  enable_timestamps: true,
});

// 输出带时间戳的文本
result.timestamps?.forEach((seg) => {
  console.log(`[${seg.start}s - ${seg.end}s] ${seg.text}`);
});
```

### 指定引擎

```typescript
// 使用 OpenAI API
const result = await engine.transcribe({
  source: "/path/to/audio.mp3",
  source_type: "file",
  provider: "openai",
  model: "whisper-1",
});

// 使用本地 Whisper
const result = await engine.transcribe({
  source: "/path/to/audio.mp3",
  source_type: "file",
  provider: "local",
  model: "medium",
});
```

## 配置选项

```typescript
interface STTConfig {
  // 优先使用的提供商
  provider: "openai" | "local" | "auto";
  
  // 临时文件目录
  tempDir: string;
  
  // 最大文件大小 (字节)
  maxFileSize: number;
  
  // OpenAI API Key (可选，也可用环境变量)
  openaiApiKey?: string;
  
  // 历史记录最大条数
  maxHistory: number;
}
```

## 与 V24 TTS 联合使用

V25 继承了 V24 的语音合成能力，可以实现完整的语音对话：

```typescript
// 用户语音 → 文字 (STT)
const transcript = await sttEngine.transcribe({
  source: userInputAudio,
  source_type: "file",
});

// 处理文字
const response = await processText(transcript.text);

// 文字 → 语音 (TTS)
const audio = await ttsEngine.synthesize({
  text: response,
  voice: "zh-CN-XiaoxiaoNeural",
});

// 播放响应
await audioPlayer.play(audio.path);
```

## 错误处理

```typescript
const result = await engine.transcribe({
  source: "/path/to/audio.mp3",
  source_type: "file",
});

if (!result.success) {
  console.error("转录失败:", result.error);
  // 处理错误
}
```

常见错误：
- `音频文件准备失败`: 文件不存在或格式不支持
- `文件过大`: 超过最大文件大小限制
- `格式不支持`: 音频格式不在支持列表中
- `引擎不可用`: OpenAI API Key 未设置或本地 Whisper 未安装

## 性能优化

1. **选择合适的模型**: 
   - 快速需求 → tiny/base
   - 平衡需求 → small/medium
   - 高准确率 → large/whisper-1

2. **使用语言提示**:
   - 指定 `language` 参数可以提高识别准确率

3. **预处理音频**:
   - 降低采样率
   - 转换为 mono 通道
   - 压缩文件大小

## 版本统计

- **新增模块**: v25-agent/stt/, v25-agent/speech/
- **新增代码**: ~1800 行
- **工具总数**: 134 个 (V24 的 129 + V25 的 5)
- **测试用例**: 25 个

## 下一步

- V26: Canvas 显示系统
- 实时语音识别
- 多说话人识别
- 语音活动检测

---

*V25 语音识别系统完成 - 2026-02-13*
