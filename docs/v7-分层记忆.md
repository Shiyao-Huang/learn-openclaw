# V7: 分层记忆系统

> **核心哲学**: "Agent 需要时间感知"

## 为什么需要分层记忆？

V6 的 Agent 有了身份，但它的记忆是扁平的。问题：

1. **无时间感**: 不知道什么时候发生了什么
2. **混杂存储**: 日常琐事和重要知识混在一起
3. **难以回顾**: 无法按时间线回顾历史

V7 引入分层记忆：
- **日记系统**: 按日期组织的短期记忆
- **长期记忆**: 重要知识的永久存储
- **时间上下文**: 自动注入当前日期信息

---

## 核心设计

### 两层记忆

| 层级 | 文件 | 用途 | 生命周期 |
|------|------|------|---------|
| 日记 | `memory/YYYY-MM-DD.md` | 当天发生的事 | 按天归档 |
| 长期 | `MEMORY.md` | 重要知识 | 永久保存 |

### LayeredMemory 类

```typescript
class LayeredMemory {
  private memoryDir: string;
  private longTermFile: string;

  constructor() {
    this.memoryDir = path.join(WORKDIR, "memory");
    this.longTermFile = path.join(WORKDIR, "MEMORY.md");
    this.ensureFiles();
  }

  // 获取今天的日期
  private getToday(): string {
    return new Date().toISOString().split("T")[0]; // YYYY-MM-DD
  }

  // 获取今天的日记文件路径
  private getDailyFile(): string {
    return path.join(this.memoryDir, `${this.getToday()}.md`);
  }

  // 追加到今天的日记
  appendDaily(content: string): string {
    const file = this.getDailyFile();
    const timestamp = new Date().toLocaleTimeString("zh-CN");
    const entry = `\n## ${timestamp}\n\n${content}\n`;
    fs.appendFileSync(file, entry);
    return `已记录到今日日记 (${this.getToday()})`;
  }

  // 获取指定日期的日记
  getDaily(date?: string): string {
    const targetDate = date || this.getToday();
    const file = path.join(this.memoryDir, `${targetDate}.md`);
    if (!fs.existsSync(file)) return `${targetDate} 没有日记`;
    return fs.readFileSync(file, "utf-8");
  }

  // 追加到长期记忆
  appendLongTerm(content: string): string {
    const entry = `\n## ${new Date().toISOString()}\n\n${content}\n`;
    fs.appendFileSync(this.longTermFile, entry);
    return "已添加到长期记忆";
  }

  // 搜索长期记忆
  searchLongTerm(query: string): string {
    if (!fs.existsSync(this.longTermFile)) return "长期记忆为空";
    const content = fs.readFileSync(this.longTermFile, "utf-8");
    // 简单的关键词搜索
    const lines = content.split("\n");
    const matches = lines.filter(line =>
      line.toLowerCase().includes(query.toLowerCase())
    );
    return matches.length > 0 ? matches.join("\n") : "未找到相关记忆";
  }

  // 获取时间上下文
  getTimeContext(): string {
    const now = new Date();
    const weekdays = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
    return `当前时间: ${now.toLocaleString("zh-CN")} (${weekdays[now.getDay()]})`;
  }
}
```

---

## 记忆工具

### daily_append

```typescript
{
  name: "daily_append",
  description: "记录到今天的日记",
  input_schema: {
    type: "object",
    properties: {
      content: { type: "string", description: "要记录的内容" }
    },
    required: ["content"]
  }
}
```

### daily_get

```typescript
{
  name: "daily_get",
  description: "获取指定日期的日记",
  input_schema: {
    type: "object",
    properties: {
      date: { type: "string", description: "日期 (YYYY-MM-DD)，不填则获取今天" }
    }
  }
}
```

### longterm_append

```typescript
{
  name: "longterm_append",
  description: "添加重要信息到长期记忆",
  input_schema: {
    type: "object",
    properties: {
      content: { type: "string", description: "要永久保存的重要信息" }
    },
    required: ["content"]
  }
}
```

### longterm_search

```typescript
{
  name: "longterm_search",
  description: "搜索长期记忆",
  input_schema: {
    type: "object",
    properties: {
      query: { type: "string", description: "搜索关键词" }
    },
    required: ["query"]
  }
}
```

### time_context

```typescript
{
  name: "time_context",
  description: "获取当前时间上下文",
  input_schema: { type: "object", properties: {} }
}
```

---

## 工作流程示例

### 记录日常工作

```
用户: 今天完成了 API 重构

Agent: [调用 daily_append]
{ content: "完成了 API 重构工作" }

已记录到今日日记 (2024-01-15)
```

### 记录重要知识

```
用户: 记住：项目的数据库密码是 xxx

Agent: [调用 longterm_append]
{ content: "项目数据库密码: xxx (敏感信息)" }

已添加到长期记忆
```

### 回顾历史

```
用户: 上周三我做了什么？

Agent: [调用 daily_get]
{ date: "2024-01-10" }

# 2024-01-10 日记

## 09:30:00
开始处理用户反馈的 bug

## 14:15:00
修复了登录页面的样式问题

## 17:00:00
完成了代码审查
```

---

## 文件结构

```
project/
├── memory/
│   ├── 2024-01-15.md    # 今天的日记
│   ├── 2024-01-14.md    # 昨天的日记
│   ├── 2024-01-13.md    # ...
│   └── ...
├── MEMORY.md            # 长期记忆
└── ...
```

### 日记文件示例

```markdown
# 2024-01-15 日记

## 09:30:00

开始处理 API 重构任务

## 11:45:00

完成了用户模块的重构

## 14:30:00

开始处理订单模块
```

### 长期记忆示例

```markdown
# 长期记忆

## 2024-01-10T10:30:00.000Z

项目架构决策：使用 PostgreSQL 作为主数据库

## 2024-01-12T15:00:00.000Z

用户偏好：喜欢简洁的代码风格，不喜欢过多注释
```

---

## 系统提示的变化

V7 的系统提示包含时间上下文：

```typescript
const SYSTEM = `${identitySystem.getSystemPrompt()}

你是 OpenClaw V7 - 有时间感知的 Agent。

${layeredMemory.getTimeContext()}

记忆规则:
- 日常事项用 daily_append 记录到日记
- 重要知识用 longterm_append 保存到长期记忆
- 用 daily_get 回顾历史日记
- 用 longterm_search 搜索重要知识

...其他规则...`;
```

---

## 与 V6 的对比

| 特性 | V6 | V7 |
|------|----|----|
| 身份系统 | ✅ | ✅ |
| 时间感知 | ❌ | ✅ 知道当前时间 |
| 分层记忆 | ❌ 扁平存储 | ✅ 日记 + 长期 |
| 历史回顾 | ❌ | ✅ 按日期查看 |

---

## 关键洞察

1. **时间维度**: 记忆需要时间标记
2. **分层存储**: 日常琐事和重要知识分开
3. **自动归档**: 日记按日期自动组织
4. **上下文注入**: 让 Agent 知道"今天是几号"

---

## 下一步

V7 的 Agent 有了时间感知，但它是被动的——只在用户请求时才行动。V8 将引入心跳系统，让 Agent 能主动检查和提醒。
