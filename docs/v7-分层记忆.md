# V7: 分层记忆系统

> 核心哲学: 记忆要有时间结构，身份要有持续上下文。

V7 在 V6 身份系统基础上，新增“日记层 + 长期层”的记忆分层，并补齐一组时间相关工具。

---

## V6 vs V7

| 维度 | V6 | V7 |
|---|---|---|
| 代码行数 | 957 | 1372 |
| 工具数 | 14 | 27 |
| 关键新增 | 身份更新 | 分层记忆 + 时间上下文 |
| 记忆形态 | 主要依赖 `.memory` | `memory/YYYY-MM-DD.md` + `MEMORY.md` |

---

## LayeredMemory 设计

### 1. 日记层（working memory）

- 文件路径: `memory/YYYY-MM-DD.md`
- 适合记录当日上下文、临时决策、过程信息

### 2. 长期层（curated memory）

- 文件路径: `MEMORY.md`
- 按 section 维护长期知识（偏好、经验、规则等）

### 3. 跨层检索

- `memory_search_all` 同时检索日记层与长期层

---

## V7 新增/扩展工具（代码实际）

### 身份与引导

- `identity_init`
- `identity_load`
- `identity_update`
- `identity_get`
- `bootstrap_complete`

### 日记层

- `daily_write`
- `daily_read`
- `daily_recent`
- `daily_list`

### 长期层

- `longterm_read`
- `longterm_update`
- `longterm_append`

### 跨层与时间

- `memory_search_all`
- `time_context`

另外 V7 工具集中也包含 `memory_stats`，用于基础记忆统计。

---

## 运行时策略

```text
会话启动
  -> 注入 time_context
  -> 可选读取 daily_recent / longterm_read
任务执行
  -> 过程写 daily_write
  -> 结论写 longterm_append
查询
  -> memory_search_all
```

---

## 与 Skill 系统的关系

V7 代码使用 `ClawLoader`，但对模型暴露工具名是 `Skill`，并兼容 `skill/claw` 参数。

---

## 最小验证

```bash
npx tsx v7-agent.ts
```

```text
>> 记录今天进展
[daily_write] {...}

>> 归档一条长期经验
[longterm_append] {...}

>> 搜索最近关于“会话”的记录
[memory_search_all] {...}
```

---

## 演进意义

V7 让记忆具备“时间维 + 结构维”，为 V8 心跳系统提供可主动检查的数据基础。

---

[← V6: 身份系统](./v6-身份系统.md) | [V8: 心跳系统 →](./v8-心跳系统.md)
