# V3: 任务规划系统

> **核心哲学**: "Make Plans Visible" - 让计划可见

## 为什么需要任务规划？

V2 的 Agent 有了记忆，但面对复杂任务时仍然是"走一步看一步"。没有明确的计划，Agent 容易：
- 遗漏步骤
- 重复工作
- 无法追踪进度

V3 引入 `TodoManager`，让 Agent 能够：
1. 分解复杂任务
2. 追踪执行进度
3. 保持聚焦（一次只做一件事）

---

## 核心设计

### TodoItem 结构

```typescript
interface TodoItem {
  content: string;      // 任务描述
  status: TodoStatus;   // pending | in_progress | completed
  activeForm: string;   // 进行时描述，如 "正在读取文件..."
}
```

**为什么只有 3 个字段？**

这是刻意的简化。参考 learn-claude-code 的设计哲学：
- `content`: 任务是什么
- `status`: 任务状态
- `activeForm`: 当前在做什么（用于 UI 显示）

不需要 `id`、`priority`、`dependencies` 等复杂字段。简单即强大。

### 约束即赋能

```typescript
// 验证约束
if (validated.length > 20) throw new Error("最多 20 个任务");
if (inProgressCount > 1) throw new Error("只能有 1 个 in_progress 任务");
```

**为什么最多 20 个任务？**
- 防止过度规划
- 强制分解为可管理的粒度

**为什么只能 1 个 in_progress？**
- 强制聚焦
- 避免多任务切换的认知负担
- 让进度可追踪

---

## TodoWrite 工具

V3 只有一个任务工具：`TodoWrite`

```typescript
{
  name: "TodoWrite",
  description: "更新任务列表。用于规划和追踪进度。每次发送完整列表（替换式）",
  input_schema: {
    type: "object",
    properties: {
      items: {
        type: "array",
        items: {
          type: "object",
          properties: {
            content: { type: "string" },
            status: { type: "string", enum: ["pending", "in_progress", "completed"] },
            activeForm: { type: "string" }
          },
          required: ["content", "status", "activeForm"]
        }
      }
    },
    required: ["items"]
  }
}
```

### 替换式更新

每次调用 `TodoWrite` 都发送**完整列表**，替换现有任务。

**为什么不用增量更新？**
- 简化实现
- 避免状态不一致
- 模型更容易理解

---

## 工作流程示例

### 用户请求

```
用户: 帮我重构 utils.ts，拆分成多个模块
```

### Agent 规划

```typescript
// Agent 调用 TodoWrite
{
  items: [
    { content: "分析 utils.ts 结构", status: "in_progress", activeForm: "正在分析文件结构..." },
    { content: "识别可拆分的模块", status: "pending", activeForm: "识别模块中..." },
    { content: "创建新文件结构", status: "pending", activeForm: "创建文件中..." },
    { content: "迁移代码", status: "pending", activeForm: "迁移代码中..." },
    { content: "更新导入语句", status: "pending", activeForm: "更新导入中..." },
    { content: "验证功能正常", status: "pending", activeForm: "验证中..." }
  ]
}
```

### 渲染输出

```
[>] 分析 utils.ts 结构 <- 正在分析文件结构...
[ ] 识别可拆分的模块
[ ] 创建新文件结构
[ ] 迁移代码
[ ] 更新导入语句
[ ] 验证功能正常

(0/6 已完成)
```

### 完成第一个任务后

```typescript
{
  items: [
    { content: "分析 utils.ts 结构", status: "completed", activeForm: "分析完成" },
    { content: "识别可拆分的模块", status: "in_progress", activeForm: "识别模块中..." },
    // ...
  ]
}
```

渲染：
```
[x] 分析 utils.ts 结构
[>] 识别可拆分的模块 <- 识别模块中...
[ ] 创建新文件结构
[ ] 迁移代码
[ ] 更新导入语句
[ ] 验证功能正常

(1/6 已完成)
```

---

## 系统提示的变化

V3 的系统提示增加了规划规则：

```typescript
const SYSTEM = `你是 OpenClaw V3 - 有规划能力的 Agent。

工作循环: plan -> execute -> track -> remember

规划规则:
- 复杂任务先用 TodoWrite 创建任务列表
- 每个任务包含: content, status, activeForm
- 同一时间只能有一个 in_progress 任务
- 最多 20 个任务

记忆规则:
- 重要信息用 memory_append 记录
- 相关知识用 memory_search 查找`;
```

---

## 代码实现

### TodoManager 类

```typescript
class TodoManager {
  private items: TodoItem[] = [];

  update(newItems: TodoItem[]): string {
    // 验证
    let inProgressCount = 0;
    const validated: TodoItem[] = [];

    for (let i = 0; i < newItems.length; i++) {
      const item = newItems[i];
      const content = (item.content || "").trim();
      const status = (item.status || "pending") as TodoStatus;
      const activeForm = (item.activeForm || "").trim();

      if (!content) throw new Error(`Item ${i}: content 必填`);
      if (!["pending", "in_progress", "completed"].includes(status)) {
        throw new Error(`Item ${i}: 无效状态 '${status}'`);
      }
      if (!activeForm) throw new Error(`Item ${i}: activeForm 必填`);

      if (status === "in_progress") inProgressCount++;

      validated.push({ content, status, activeForm });
    }

    // 约束检查
    if (validated.length > 20) throw new Error("最多 20 个任务");
    if (inProgressCount > 1) throw new Error("只能有 1 个 in_progress 任务");

    this.items = validated;
    return this.render();
  }

  render(): string {
    if (this.items.length === 0) return "暂无任务";

    const lines: string[] = [];
    for (const item of this.items) {
      if (item.status === "completed") {
        lines.push(`[x] ${item.content}`);
      } else if (item.status === "in_progress") {
        lines.push(`[>] ${item.content} <- ${item.activeForm}`);
      } else {
        lines.push(`[ ] ${item.content}`);
      }
    }

    const completed = this.items.filter(t => t.status === "completed").length;
    lines.push(`\n(${completed}/${this.items.length} 已完成)`);

    return lines.join("\n");
  }
}
```

---

## 与 V2 的对比

| 特性 | V2 | V3 |
|------|----|----|
| 记忆 | ✅ LocalMemory | ✅ LocalMemory |
| 任务规划 | ❌ | ✅ TodoManager |
| 进度追踪 | ❌ | ✅ |
| 聚焦约束 | ❌ | ✅ 只能 1 个 in_progress |

---

## 关键洞察

1. **约束即赋能**: 限制反而带来清晰
2. **替换式更新**: 简化状态管理
3. **可见性**: 让计划对用户可见
4. **简单结构**: 3 个字段足够

---

## 下一步

V3 的 Agent 能规划任务了，但所有工作都在一个进程中完成。V4 将引入子代理，实现任务的并行执行和上下文隔离。
