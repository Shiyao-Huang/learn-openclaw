# V3: 任务规划系统

> 核心哲学: 把计划显式化，才能稳定执行复杂任务。

V3 在 V2 记忆能力上新增 `TodoManager` 和 `TodoWrite`，让 Agent 不再“走一步看一步”。

---

## V2 vs V3

| 维度 | V2 | V3 |
|---|---|---|
| 代码行数 | 481 | 551 |
| 工具数 | 10 | 11 |
| 关键新增 | - | `TodoWrite` |
| 任务状态 | 隐式 | 显式（pending/in_progress/completed） |

---

## Todo 数据模型

```typescript
type TodoStatus = "pending" | "in_progress" | "completed";

interface TodoItem {
  content: string;
  status: TodoStatus;
  activeForm: string;
}
```

约束：

- 最多 20 条任务
- 同时最多 1 条 `in_progress`

---

## TodoWrite 工具

```typescript
TodoWrite({ items: TodoItem[] })
```

这是“替换式更新”：每次提交完整任务列表，而不是增量 patch。

这样做的好处：

1. 状态一致性更容易保证
2. 模型行为更可预测
3. 输出可直接渲染为进度面板

---

## 典型流程

```text
用户请求复杂任务
  -> TodoWrite 建立完整计划
  -> 执行当前 in_progress
  -> TodoWrite 更新状态
  -> 全部 completed 后收尾
```

渲染示例：

```text
[x] 读取项目结构
[>] 重构 utils 模块 <- 正在提取公共函数...
[ ] 更新测试
(1/3 已完成)
```

---

## 与 V2 的关系

V3 不替换 V2 记忆，而是叠加：

- V2 负责“知道什么”
- V3 负责“先做什么、后做什么”

---

## 最小验证

```bash
npx tsx v3-agent.ts
```

```text
>> 请分步骤重构这个文件并告诉我进度
[TodoWrite] {...}
```

---

## 演进意义

V3 把 Agent 从“会工具调用”推进到“有执行纪律”。V4 才能在这个基础上做子任务委托与隔离。

---

[← V2: 本地向量记忆系统](./v2-向量记忆系统.md) | [V4: 子代理协调 →](./v4-子代理协调.md)
