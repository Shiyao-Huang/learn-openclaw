# V5.5: Hook 系统

> 核心哲学: 在不改核心循环的前提下，开放关键生命周期扩展点。

V5.5 是过渡版本：在 V5 的技能体系上，引入最小可用 Hook 基础设施。

- 新增 `HookSystem`
- 新增 `BootstrapManager`
- 在主入口触发 `session:start / session:end`
- 在初始化阶段触发 `bootstrap:files`

---

## 与 V5 的关系

| 维度 | V5 | V5.5 |
|---|---|---|
| 目标 | 技能加载 | 生命周期可扩展 |
| 关键新增 | `SkillLoader` | `HookSystem` + `BootstrapManager` |
| 工具数 | 12 | 12 |
| 技能工具名 | `Skill` | `Skill` |
| 代码规模 | 614 行 | 777 行 |

说明：V5.5 的重点是 Hook，不是新增业务工具。

---

## Hook 类型（代码实际）

```typescript
type HookType = "bootstrap:files" | "session:start" | "session:end";
```

### `bootstrap:files`

在系统提示构建前触发，可修改 bootstrap 内容集合。

### `session:start` / `session:end`

在会话开始/结束时触发，适合做埋点、状态同步或资源清理。

---

## HookSystem 最小实现

```typescript
class HookSystem {
  private handlers: Map<HookType, HookHandler[]> = new Map();

  register(type, handler) { ... }

  async emit(type, context = {}) {
    const event = { type, context, prevented: false };
    for (const handler of handlers) {
      await handler(event);
      if (event.prevented) break;
    }
    return event;
  }
}
```

设计要点：

- 支持多 handler
- 支持 `prevented` 短路
- 不引入复杂事件总线

---

## BootstrapManager

`bootstrap/` 目录下按文件名前缀数字排序（如 `01-identity.md`），合并为注入段落。

```text
bootstrap/
  01-identity.md
  10-tone.md
```

合并后插入系统提示 `## 身份与人格` 区段。

---

## 工具层变化

V5.5 仍维持 12 个工具，包含：

- 基础工具: `bash/read_file/write_file/edit_file/grep`
- 记忆工具: `memory_search/get/append/ingest`
- 规划: `TodoWrite`
- 委托: `subagent`
- 技能: `Skill`

`Skill` 支持 `skill='list'`。

---

## 启动时序

```text
initialize()
  -> emit("bootstrap:files")
  -> buildSystemPrompt()
main()
  -> emit("session:start")
  -> chat loop
  -> emit("session:end")
```

---

## 最小验证

```bash
npx tsx v5.5-agent.ts
```

看启动日志是否出现：

- `OpenClaw V5.5 - Hook 增强型 Agent`
- `Bootstrap: 已加载人格文件`（若 `bootstrap/` 存在）

---

## 演进意义

V5.5 把“可扩展点”先建出来，V6 才能把身份系统接进来而不硬改主循环。

---

[← V5: Skill 系统](./v5-Claw系统.md) | [V6: 身份系统 →](./v6-身份系统.md)
