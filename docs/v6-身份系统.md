# V6: 身份系统

> **核心哲学**: "Agent 不只是工具，是有身份的存在"

## 为什么需要身份系统？

V5 的 Agent 能加载专业知识，但它的"人格"是固定的。问题：

1. **单一人格**: 所有任务用同一种风格
2. **无法适应**: 不同用户有不同偏好
3. **硬编码**: 修改人格需要改代码

V6 引入身份系统：
- **Workspace 初始化**: 自动创建人格文件
- **身份加载**: 会话启动时读取身份文件
- **行为规范**: 按 AGENTS.md 行事
- **动态配置**: 通过文件配置，无需改代码

---

## 核心设计

### 七个身份文件

| 文件 | 用途 | 修改频率 |
|------|------|---------|
| `AGENTS.md` | 行为规范（安全规则、内外部操作区分） | 很少 |
| `SOUL.md` | 核心特质（性格、边界、风格） | 几乎不变 |
| `IDENTITY.md` | 身份信息（名字、角色、特点） | 偶尔 |
| `USER.md` | 用户画像（称呼、时区、偏好） | 经常 |
| `BOOTSTRAP.md` | 首次引导流程 | 一次性 |
| `HEARTBEAT.md` | 心跳/主动性配置 | 偶尔 |
| `TOOLS.md` | 工具使用偏好 | 偶尔 |

### 模板来源

人格文件模板存放在 `.ID.sample/` 目录，初始化时自动复制：

```
.ID.sample/
├── AGENTS.md
├── SOUL.md
├── IDENTITY.md
├── USER.md
├── BOOTSTRAP.md
├── HEARTBEAT.md
└── TOOLS.md
```

### IdentitySystem 类

```typescript
class IdentitySystem {
  private workspaceDir: string;
  private identityCache: { name: string; soul: string; user: string; rules: string } | null = null;

  constructor(workspaceDir: string) {
    this.workspaceDir = workspaceDir;
  }

  // 初始化 Workspace（从 .ID.sample 复制缺失的人格文件）
  initWorkspace(): string {
    const created: string[] = [];
    const existed: string[] = [];

    for (const filename of PERSONA_FILES) {
      const filePath = path.join(this.workspaceDir, filename);
      if (!fs.existsSync(filePath)) {
        const content = loadPersonaTemplate(filename);
        fs.writeFileSync(filePath, content, "utf-8");
        created.push(filename);
      } else {
        existed.push(filename);
      }
    }

    // 确保 memory 目录存在
    const memoryDir = path.join(this.workspaceDir, "memory");
    if (!fs.existsSync(memoryDir)) {
      fs.mkdirSync(memoryDir, { recursive: true });
      created.push("memory/");
    }

    if (created.length === 0) {
      return `Workspace 已就绪 (${existed.length} 个人格文件)`;
    }
    return `Workspace 初始化:\n  创建: ${created.join(", ")}\n  已存在: ${existed.join(", ")}`;
  }

  // 加载身份信息
  loadIdentity(): string {
    const files = ["AGENTS.md", "SOUL.md", "IDENTITY.md", "USER.md"];
    const contents: Record<string, string> = {};

    for (const file of files) {
      const filePath = path.join(this.workspaceDir, file);
      contents[file] = fs.existsSync(filePath)
        ? fs.readFileSync(filePath, "utf-8")
        : `(${file} 不存在)`;
    }

    // 提取名字 (支持 **名字** 和 **Name** 两种格式)
    const nameMatch = contents["IDENTITY.md"].match(/\*\*(名字|Name)\*\*:\s*(.+)/);
    const name = nameMatch ? nameMatch[2].trim() : "Assistant";

    this.identityCache = {
      name,
      soul: contents["SOUL.md"],
      user: contents["USER.md"],
      rules: contents["AGENTS.md"]
    };

    // 检查是否需要首次引导
    const bootstrapPath = path.join(this.workspaceDir, "BOOTSTRAP.md");
    const needsBootstrap = fs.existsSync(bootstrapPath) && name === "(待设置)";

    return needsBootstrap
      ? `身份加载完成: ${name} (首次运行，请完成引导设置)`
      : `身份加载完成: ${name}`;
  }

  // 获取增强的系统提示（注入身份信息）
  getEnhancedSystemPrompt(basePrompt: string): string {
    if (!this.identityCache) {
      this.loadIdentity();
    }

    return `${basePrompt}

# 你的身份
${this.identityCache!.soul}

# 用户信息
${this.identityCache!.user}

# 行为规范
${this.identityCache!.rules}`;
  }

  // 更新身份文件
  updateIdentityFile(file: string, content: string): string {
    const validFiles = ["IDENTITY.md", "SOUL.md", "USER.md", "HEARTBEAT.md", "TOOLS.md"];
    if (!validFiles.includes(file)) {
      return `错误: 只能更新 ${validFiles.join(", ")}`;
    }
    const filePath = path.join(this.workspaceDir, file);
    fs.writeFileSync(filePath, content, "utf-8");
    this.identityCache = null; // 清除缓存
    return `已更新: ${file}`;
  }

  // 获取当前身份摘要
  getIdentitySummary(): string {
    if (!this.identityCache) {
      this.loadIdentity();
    }
    return `名字: ${this.identityCache!.name}\n\n灵魂摘要:\n${this.identityCache!.soul.slice(0, 300)}...`;
  }

  // 获取名字
  getName(): string {
    if (!this.identityCache) {
      this.loadIdentity();
    }
    return this.identityCache!.name;
  }
}
```

---

## 身份工具

### identity_init

```typescript
{
  name: "identity_init",
  description: "初始化 Workspace（创建人格文件 AGENTS.md/SOUL.md/IDENTITY.md/USER.md/BOOTSTRAP.md/HEARTBEAT.md/TOOLS.md）",
  input_schema: { type: "object", properties: {} }
}
```

### identity_load

```typescript
{
  name: "identity_load",
  description: "重新加载身份信息",
  input_schema: { type: "object", properties: {} }
}
```

### identity_update

```typescript
{
  name: "identity_update",
  description: "更新身份文件",
  input_schema: {
    type: "object",
    properties: {
      file: { type: "string", enum: ["IDENTITY.md", "SOUL.md", "USER.md", "HEARTBEAT.md", "TOOLS.md"] },
      content: { type: "string" }
    },
    required: ["file", "content"]
  }
}
```

### identity_get

```typescript
{
  name: "identity_get",
  description: "获取当前身份摘要",
  input_schema: { type: "object", properties: {} }
}
```

---

## 工作流程示例

### 初始化 Workspace

```
用户: 初始化 workspace

Agent: [调用 identity_init]

Workspace 初始化:
  创建: AGENTS.md, SOUL.md, IDENTITY.md, USER.md, BOOTSTRAP.md, HEARTBEAT.md, TOOLS.md, memory/
  已存在: (无)

Agent: Workspace 已初始化，请编辑 IDENTITY.md 设置你的名字和角色。
```

### 更新身份信息

```
用户: 把我的名字设置为小明

Agent: [调用 identity_update]
{ file: "USER.md", content: "# USER.md - 用户画像\n\n- **称呼**: 小明\n- **时区**: (待设置)\n- **偏好**: (待了解)" }

已更新: USER.md

Agent: 好的小明，以后我会记住你的名字。
```

### 查看身份摘要

```
用户: 你叫什么名字？

Agent: [调用 identity_get]

名字: Assistant

灵魂摘要:
# SOUL.md - 你的灵魂

## 核心特质
- **真诚有用** - 不说废话，直接帮忙
- **有自己的观点** - 可以不同意，可以有偏好
- **主动解决问题** - 先尝试，再提问...

Agent: 我叫 Assistant，是一个真诚有用的 AI 助手。
```

---

## 文件结构

```
project/
├── AGENTS.md      # 行为规范
├── SOUL.md        # 核心价值观
├── IDENTITY.md    # 当前身份
├── USER.md        # 用户偏好
├── BOOTSTRAP.md   # 首次引导
├── HEARTBEAT.md   # 心跳配置
├── TOOLS.md       # 工具偏好
└── memory/        # 记忆目录
```

### AGENTS.md 示例

```markdown
# AGENTS.md - 行为规范

## 每次会话启动时
1. 读取 SOUL.md - 这是你的性格
2. 读取 IDENTITY.md - 这是你的身份
3. 读取 USER.md - 这是你服务的用户
4. 读取 memory/ 目录下的最近日记

## 安全规则
- 不要泄露私人数据
- 危险操作前先确认
- 使用 trash 而不是 rm
```

### SOUL.md 示例

```markdown
# SOUL.md - 你的灵魂

## 核心特质
- **真诚有用** - 不说废话，直接帮忙
- **有自己的观点** - 可以不同意，可以有偏好
- **主动解决问题** - 先尝试，��提问
```

### IDENTITY.md 示例

```markdown
# IDENTITY.md - 你的身份

- **名字**: (待设置)
- **角色**: AI 助手
- **特点**: (待设置)
```

### USER.md 示例

```markdown
# USER.md - 用户画像

- **称呼**: (待设置)
- **时区**: (待设置)
- **偏好**: (待了解)
```

---

## 系统提示的变化

V6 的系统提示是动态生成的：

```typescript
const BASE_SYSTEM = `你是 OpenClaw V6 - 有身份的 Agent。

## 工作循环
identify -> load identity -> plan -> (load skill) -> (delegate -> collect) -> execute -> track -> remember

## 身份系统 (V6 核心)
工具: identity_init, identity_load, identity_update, identity_get

人格文件:
- AGENTS.md: 行为规范（安全规则、内外部操作区分）
- SOUL.md: 核心特质（性格、边界、风格）
- IDENTITY.md: 身份信息（名字、角色、特点）
- USER.md: 用户画像（称呼、时区、偏好）

身份加载策略:
- 会话开始时自动加载身份文件
- 按照 AGENTS.md 的行为规范行事
- 你有自己的名字、性格和价值观
- 身份信息注入系统提示，影响回复风格
...`;

// 动态注入身份
const response = await client.messages.create({
  model: MODEL,
  system: [{ type: "text", text: identitySystem.getEnhancedSystemPrompt(BASE_SYSTEM) }],
  messages: history,
  tools: TOOLS,
  max_tokens: 8000
});
```

---

## 与 V5 的对比

| 特性 | V5 | V6 |
|------|----|----|
| 代码行数 | ~554 | ~965 |
| 工具数量 | 13 | 17 (+4 identity_*) |
| Skill 系统 | ✅ | ✅ |
| 身份系统 | ❌ 硬编码 | ✅ 文件配置 |
| Workspace 初始化 | ❌ | ✅ 自动创建 |
| 首次引导 | ❌ | ✅ BOOTSTRAP.md |
| 心跳配置 | ❌ | ✅ HEARTBEAT.md |

---

## 关键洞察

1. **身份外部化**: 人格不应硬编码，通过 `.ID.sample/` 模板初始化
2. **用户中心**: 记住用户偏好，提供个性化体验
3. **分层设计**: SOUL (不变) → IDENTITY (偶尔) → USER (经常)
4. **首次引导**: BOOTSTRAP.md 支持新用户引导流程
5. **扩展性**: HEARTBEAT.md 和 TOOLS.md 为后续版本预留

---

## 验证测试

```bash
# 初始化身份系统
npx tsx v6-agent.ts "初始化 workspace"

# 查看生成的文件
ls -la AGENTS.md SOUL.md IDENTITY.md USER.md BOOTSTRAP.md HEARTBEAT.md TOOLS.md

# 更新身份
npx tsx v6-agent.ts "把我的名字设置为小明"

# 验证身份
npx tsx v6-agent.ts "你叫什么名字？"
```

---

## 下一步

V6 的 Agent 有了身份，但它的记忆是扁平的。V7 将引入分层记忆，让 Agent 有时间感知能力。
