# V6: 身份系统

> 核心哲学: 人格是文件，不是硬编码字符串。

V6 把“身份配置”从静态 system prompt 变成 workspace 文件，并引入首次引导闭环。

---

## V5.5 vs V6

| 维度 | V5.5 | V6 |
|---|---|---|
| 核心重点 | Hook 基础设施 | 身份文件 + 首次引导 |
| 工具数 | 12 | 14 |
| 新增工具 | - | `identity_update`, `bootstrap_complete` |
| 代码规模 | 777 行 | 1041 行 |

注意：V6 的 `identity_init/load/get` 在类里有实现，但**不是对模型暴露的工具**。

---

## 人格文件集合

V6 的 `PERSONA_FILES`：

- `AGENTS.md`
- `SOUL.md`
- `IDENTITY.md`
- `USER.md`
- `BOOTSTRAP.md`
- `HEARTBEAT.md`
- `TOOLS.md`

初始化时会自动补齐缺失文件，并确保 `memory/` 存在。

---

## IdentitySystem 关键职责

### 1. `initWorkspace()`

- 创建缺失人格文件
- 对“全新 workspace”才创建 `BOOTSTRAP.md`
- 创建 `memory/`

### 2. `loadIdentity()`

- 读取人格文件
- 解析名字（兼容 `Name/名字` 写法）
- 若 `BOOTSTRAP.md` 存在且名字未设置，则返回首次引导信号

### 3. `buildSystemPrompt(basePrompt)`

- 注入 SOUL/USER/AGENTS 内容
- 结合 Hook 机制支持 `bootstrap:files` 修改

---

## V6 暴露给模型的身份工具

```typescript
identity_update(file, content)
bootstrap_complete()
```

### `identity_update`

可更新：

- `IDENTITY.md`
- `SOUL.md`
- `USER.md`
- `AGENTS.md`
- `HEARTBEAT.md`
- `TOOLS.md`

并在更新后重建系统提示。

### `bootstrap_complete`

完成首次引导后删除 `BOOTSTRAP.md`，退出引导状态。

---

## Skill 兼容细节（代码实际）

V6 使用 `ClawLoader` 读取 `claws/*/CLAW.md`，但对模型暴露的工具名是 `Skill`：

```typescript
case "Skill":
  const skillName = args.skill ?? args.claw;
  ...
```

即同时兼容 `skill` 和 `claw` 参数。

---

## 启动流程（主入口）

```text
initialize()
  -> identitySystem.initWorkspace()
  -> identitySystem.loadIdentity()
  -> emit("bootstrap:files")
  -> build SYSTEM
if bootstrap mode:
  自动发起引导对话
```

---

## 最小验证

```bash
npx tsx v6-agent.ts
```

验证点：

1. 首次运行会创建人格文件。
2. 名字未配置时进入引导模式。
3. 调用 `identity_update` 后，后续回复风格会变化。
4. 调用 `bootstrap_complete` 后不会再次进入首次引导。

---

## 演进意义

V6 让 Agent 的“行为与人格”具备可持续运营能力：

- 可配置
- 可持久化
- 可在会话中更新

这为 V7 的时间维记忆和长期个性稳定打下基础。

---

[← V5.5: Hook 系统](./v5.5-Hook系统.md) | [V7: 分层记忆 →](./v7-分层记忆.md)
