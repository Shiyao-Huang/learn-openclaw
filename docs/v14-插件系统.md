# V14: 插件系统

> 动态加载外部能力，让 Agent 可扩展

## 设计理念

V14 引入 Plugin System，实现能力的模块化和动态加载：
1. 插件接口 - 统一的插件定义规范
2. 工具热插拔 - 运行时加载/卸载工具
3. 配置 Schema - 插件配置验证和 UI hints
4. 生命周期钩子 - 插件可以响应 Agent 事件

## 核心架构

### 插件接口

```typescript
interface Plugin {
  id: string;                    // 唯一标识
  name: string;                  // 显示名称
  version: string;               // 版本号
  description?: string;          // 描述
  author?: string;               // 作者
  
  // 配置
  configSchema?: PluginConfigSchema;
  
  // 能力
  tools?: PluginTool[];          // 提供的工具
  hooks?: PluginHook[];          // 生命周期钩子
  
  // 生命周期
  onLoad?: (ctx: PluginContext) => Promise<void> | void;
  onUnload?: () => Promise<void> | void;
}
```

### 插件工具

```typescript
interface PluginTool {
  name: string;
  description: string;
  inputSchema: Record<string, unknown>;
  handler: (args: Record<string, unknown>, ctx: ToolContext) => Promise<string> | string;
}
```

### 配置 Schema

```typescript
interface PluginConfigSchema {
  type: 'object';
  properties: Record<string, {
    type: 'string' | 'number' | 'boolean' | 'array';
    description?: string;
    default?: unknown;
    required?: boolean;
    sensitive?: boolean;    // 敏感信息（如 API key）
    uiHint?: string;        // UI 提示
  }>;
}
```

### 生命周期钩子

```typescript
type PluginHookName = 
  | 'before_agent_start'
  | 'after_agent_end'
  | 'before_tool_call'
  | 'after_tool_call'
  | 'message_received'
  | 'message_sending';

interface PluginHook {
  name: PluginHookName;
  priority?: number;        // 执行优先级 (默认 100)
  handler: (event: HookEvent) => Promise<HookResult | void> | HookResult | void;
}
```

## 工具列表

| 工具 | 描述 |
|------|------|
| `plugin_list` | 列出所有已加载插件 |
| `plugin_load` | 加载插件 (从文件或 npm) |
| `plugin_unload` | 卸载插件 |
| `plugin_config` | 查看/更新插件配置 |
| `plugin_info` | 查看插件详情 |

## 插件发现

```
插件目录结构:
plugins/
├── my-plugin/
│   ├── package.json      # 包含 openclaw.plugin 字段
│   └── index.ts          # 插件入口
└── another-plugin.ts     # 单文件插件
```

### package.json 示例

```json
{
  "name": "my-weather-plugin",
  "version": "1.0.0",
  "openclaw": {
    "plugin": true,
    "entry": "index.ts"
  }
}
```

## 插件示例

### 天气插件

```typescript
// plugins/weather/index.ts
import type { Plugin } from '../types';

const weatherPlugin: Plugin = {
  id: 'weather',
  name: 'Weather Plugin',
  version: '1.0.0',
  description: '获取天气信息',
  
  configSchema: {
    type: 'object',
    properties: {
      apiKey: {
        type: 'string',
        description: 'OpenWeather API Key',
        sensitive: true,
        required: true
      },
      defaultCity: {
        type: 'string',
        description: '默认城市',
        default: 'Beijing'
      }
    }
  },
  
  tools: [{
    name: 'get_weather',
    description: '获取指定城市的天气',
    inputSchema: {
      type: 'object',
      properties: {
        city: { type: 'string', description: '城市名' }
      }
    },
    handler: async (args, ctx) => {
      const city = args.city || ctx.config.defaultCity;
      // 调用天气 API...
      return `${city} 天气: 晴, 25°C`;
    }
  }],
  
  hooks: [{
    name: 'before_agent_start',
    handler: (event) => {
      console.log('Weather plugin ready!');
    }
  }]
};

export default weatherPlugin;
```

## 插件管理器

```typescript
class PluginManager {
  private plugins: Map<string, LoadedPlugin> = new Map();
  private pluginDir: string;
  
  // 发现插件
  async discover(): Promise<PluginCandidate[]>;
  
  // 加载插件
  async load(source: string): Promise<Plugin>;
  
  // 卸载插件
  async unload(pluginId: string): Promise<void>;
  
  // 获取所有工具
  getTools(): PluginTool[];
  
  // 触发钩子
  async triggerHook(name: PluginHookName, event: HookEvent): Promise<void>;
  
  // 获取插件配置
  getConfig(pluginId: string): Record<string, unknown>;
  
  // 更新插件配置
  setConfig(pluginId: string, config: Record<string, unknown>): void;
}
```

## 安全考虑

1. **沙箱执行**: 插件代码在受限环境运行
2. **权限声明**: 插件需声明所需权限
3. **配置验证**: 自动验证配置符合 schema
4. **敏感数据**: 标记为 sensitive 的配置不会被日志记录

## 与现有系统集成

- **Security (V12)**: 插件工具自动纳入安全策略
- **Evolution (V13)**: 插件使用模式可被分析
- **Compression (V13.5)**: 插件工具输出同样被压缩

## 演进路线

```
V13.5 (上下文压缩)
    ↓
V14 (插件系统) ← 当前
    ↓
V15 (多模型协作)
```

## 代码统计预估

- 新增代码: ~400 行
- 新增工具: 5 个
- 总工具数: ~64 个
