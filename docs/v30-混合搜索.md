# V30: 混合搜索系统

> 结合向量搜索 + 关键词搜索，实现更精准的检索

---

## 概述

V30 引入混合搜索引擎，整合了 V27 的向量嵌入能力和全新的全文搜索 (FTS) 能力，通过智能权重调整和结果重排序，提供最佳的搜索体验。

---

## 架构

```
┌─────────────────────────────────────────────────────────────┐
│                    HybridSearchEngine                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌───────────────┐    ┌───────────────┐    ┌──────────────┐ │
│  │   查询分析    │ -> │  权重调整     │ -> │   并行搜索   │ │
│  └───────────────┘    └───────────────┘    └──────────────┘ │
│                                                  │          │
│                    ┌─────────────────────────────┼──────┐   │
│                    │                             │      │   │
│                    ▼                             ▼      │   │
│           ┌───────────────┐           ┌───────────────┐ │   │
│           │  向量搜索     │           │  关键词搜索   │ │   │
│           │ (V27 Embedding)│           │ (SQLite FTS5)│ │   │
│           └───────────────┘           └───────────────┘ │   │
│                    │                             │      │   │
│                    └──────────┬──────────────────┘      │   │
│                               ▼                         │   │
│                    ┌───────────────┐                    │   │
│                    │  结果合并     │                    │   │
│                    └───────────────┘                    │   │
│                               │                         │   │
│                               ▼                         │   │
│                    ┌───────────────┐                    │   │
│                    │  重排序       │                    │   │
│                    │ (多样性优化)  │                    │   │
│                    └───────────────┘                    │   │
│                                                      │   │
└─────────────────────────────────────────────────────────────┘
```

---

## 工具列表

| 工具 | 描述 | 参数 |
|------|------|------|
| `hybrid_search` | 混合搜索 | query, maxResults?, vectorWeight?, keywordWeight?, minScore? |
| `hybrid_vector_search` | 仅向量搜索 | query, maxResults? |
| `hybrid_keyword_search` | 仅关键词搜索 | query, maxResults? |
| `hybrid_index` | 索引文档 | id?, path, content, source? |
| `hybrid_index_batch` | 批量索引 | documents[] |
| `hybrid_delete` | 删除文档 | id |
| `hybrid_status` | 引擎状态 | - |
| `hybrid_stats` | 搜索统计 | - |
| `hybrid_history` | 搜索历史 | limit? |
| `hybrid_clear` | 清空索引 | - |

---

## 使用示例

### 基础混合搜索

```typescript
// 索引文档
await hybrid_index({
  path: "/docs/architecture.md",
  content: "The hybrid search system combines vector embeddings with full-text search...",
  source: "documentation"
});

// 执行搜索
const results = await hybrid_search({
  query: "how does hybrid search work",
  maxResults: 10
});
```

### 调整权重

```typescript
// 技术查询 - 提高关键词权重
const codeResults = await hybrid_search({
  query: "getUserData function",
  vectorWeight: 0.4,
  keywordWeight: 0.6
});

// 自然语言查询 - 提高向量权重
const semanticResults = await hybrid_search({
  query: "what are the best practices for error handling",
  vectorWeight: 0.8,
  keywordWeight: 0.2
});
```

### 仅使用一种搜索方式

```typescript
// 纯语义搜索
const semanticOnly = await hybrid_vector_search({
  query: "机器学习的基本概念"
});

// 纯关键词搜索
const keywordOnly = await hybrid_keyword_search({
  query: "getUserData camelCase"
});
```

### 批量索引

```typescript
await hybrid_index_batch({
  documents: [
    {
      path: "/src/auth.ts",
      content: "export function authenticate(user, password) {...}",
      source: "code"
    },
    {
      path: "/docs/auth.md",
      content: "# Authentication\n\nThe authentication system...",
      source: "documentation"
    }
  ]
});
```

---

## 核心特性

### 1. 智能权重调整

系统会自动分析查询特征，动态调整向量搜索和关键词搜索的权重：

- **技术术语多** (camelCase, snake_case, 函数名等) → 提高关键词权重
- **自然语言多** (疑问词, 介词等) → 提高向量权重

```typescript
// 自动权重调整示例
adjustWeights("getUserData function");    // { vectorWeight: 0.5, keywordWeight: 0.5 }
adjustWeights("what is machine learning"); // { vectorWeight: 0.8, keywordWeight: 0.2 }
```

### 2. 结果合并

向量和关键词搜索结果通过加权平均合并：

```
hybridScore = vectorWeight * vectorScore + keywordWeight * keywordScore
```

同时匹配两种搜索的文档会获得更高的分数。

### 3. 多样性重排序

结果会根据来源多样性进行重排序，避免所有结果来自同一来源：

```typescript
rerankResults(results, { diversityBoost: 0.1 });
```

---

## 技术细节

### FTS 引擎

- 基于 SQLite FTS5
- 支持 Porter 词干提取器
- BM25 排序算法
- 中文支持 (Unicode61 分词)

### 向量集成

- 复用 V27 Embedding 引擎
- 支持 OpenAI Embeddings API
- 本地 Jaccard 相似度作为 fallback

### 性能优化

- 并行执行向量和关键词搜索
- 结果缓存
- 历史记录限制 (最多 1000 条)

---

## 依赖

- `better-sqlite3`: SQLite 数据库 (FTS5)
- V27 Embedding 引擎 (可选)

---

## 与其他版本的关系

- **V27 Embedding**: 提供向量搜索能力
- **V29 Security**: 提供安全审计能力 (继承)

V30 是 V29 的超集，包含所有 V29 的功能。

---

## 测试覆盖

- FTS 引擎测试: 5 个
- 混合搜索引擎测试: 7 个
- 结果合并测试: 1 个
- 权重调整测试: 2 个
- 重排序测试: 1 个
- 工具处理器测试: 5 个

**总计: 21 个测试**

---

*Last updated: 2026-02-16 - V30 混合搜索系统完成*
