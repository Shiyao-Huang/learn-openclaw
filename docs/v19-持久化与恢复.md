# V19: 持久化与恢复系统

## 概述

V19 引入完整的持久化与恢复系统，让 Agent 能够：
- 创建完整状态快照
- 任务断点续传
- 崩溃后自动恢复
- 定期自动保存

## 核心组件

### 1. PersistenceManager - 持久化管理器

负责状态快照、检查点和磁盘持久化。

```typescript
const manager = new PersistenceManager(workDir, {
  maxSnapshots: 10,
  maxCheckpointsPerTask: 5,
  autoSnapshotIntervalMs: 300000, // 5分钟
});
```

### 2. RecoveryHandler - 恢复处理器

处理状态恢复、任务续传和故障转移。

```typescript
const recovery = new RecoveryHandler(manager, {
  onStateRestored: (snapshot) => console.log("状态已恢复"),
  onTaskResumed: (task) => console.log("任务已恢复"),
});
```

## 新增工具

| 工具 | 描述 |
|------|------|
| `snapshot_create` | 创建完整状态快照 |
| `snapshot_list` | 列出所有快照 |
| `snapshot_restore` | 从快照恢复状态 |
| `snapshot_delete` | 删除快照 |
| `checkpoint_create` | 创建任务检查点 |
| `checkpoint_get` | 获取检查点数据 |
| `auto_snapshot_config` | 配置自动快照 |
| `recovery_check` | 检查恢复需求 |
| `recovery_execute` | 执行自动恢复 |
| `crash_history` | 查看崩溃历史 |
| `persistence_report` | 生成持久化报告 |

## 使用方法

### 创建快照

```typescript
// 手动创建快照
const snapshot = await persistenceManager.createSnapshot(
  agentState,
  sessionState,
  tasks,
  subagents,
  memory,
  workflow,
  "手动快照",
  "用户触发的快照",
  ["manual"]
);
```

### 配置自动快照

```bash
# .env
AUTO_SNAPSHOT_MINUTES=5
```

或在运行时：

```typescript
auto_snapshot_config({
  enabled: true,
  intervalMinutes: 5
})
```

### 任务检查点

```typescript
// 在长时间任务中创建检查点
checkpoint_create({
  taskId: "task-123",
  step: 5,
  data: { processedItems: 100, results: [...] }
});
```

### 崩溃恢复

V19 启动时自动检查恢复需求：

```typescript
// 检查是否需要恢复
const check = recoveryHandler.checkRecoveryNeeded();
if (check.needed) {
  await recoveryHandler.autoRecover();
}
```

## 状态结构

### StateSnapshot

```typescript
interface StateSnapshot {
  metadata: SnapshotMetadata;      // 快照元数据
  agent: AgentState;               // Agent 状态
  session: SessionState;           // 会话状态
  tasks: TaskState[];              // 任务列表
  subagents: SubAgentState[];      // 子代理列表
  memory: MemoryState;             // 记忆状态
  workflow: WorkflowState;         // 工作流状态
}
```

### TaskCheckpoint

```typescript
interface TaskCheckpoint {
  step: number;                    // 当前步骤
  data: Record<string, unknown>;   // 检查点数据
  timestamp: number;               // 创建时间
}
```

## CLI 命令

| 命令 | 描述 |
|------|------|
| `/snapshots` | 查看快照状态 |
| `/recovery` | 查看恢复状态 |
| `/persist` | 查看完整持久化报告 |

## 文件存储

```
workDir/
├── snapshots/           # 状态快照
│   ├── snap_xxx.json
│   └── snap_yyy.json
├── checkpoints/         # 任务检查点
│   ├── task_xxx.json
│   └── subagent_yyy.json
└── subagents/          # 子代理工作目录
    └── ...
```

## 恢复策略

1. **自动恢复**: 启动时检查未恢复的崩溃
2. **快照恢复**: 从完整快照恢复所有状态
3. **检查点恢复**: 从任务检查点续传
4. **故障转移**: 组件级别恢复

## 最佳实践

1. **定期快照**: 配置自动快照，避免数据丢失
2. **任务检查点**: 长时间任务应定期创建检查点
3. **崩溃处理**: 总是检查崩溃历史，确保问题已解决
4. **存储管理**: 定期清理旧快照，避免磁盘空间不足

## 测试

```bash
npm test -- tests/v19-persistence.test.ts
```

## 升级指南

从 V18 升级到 V19:

1. 添加 `AUTO_SNAPSHOT_MINUTES` 到 `.env`
2. 迁移子代理使用新的检查点 API
3. 更新工作流以支持状态恢复

## 下一步

- V20: 分布式 Agent 集群
