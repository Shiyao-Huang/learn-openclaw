# V15 → V16: DAG 工作流引擎

## 新增能力

V16 引入 DAG (有向无环图) 工作流引擎，支持：
- Mermaid → DAG 解析：从人类可读语法创建工作流
- 并行执行识别：自动分析依赖关系
- 条件分支：支持 yes/no 逻辑
- 错误恢复：重试机制和跳过策略

## 架构变化

V16 采用模块化目录结构（继承 V11 模式）：

```
v16-agent/
├── index.ts           # 主入口
├── workflow/
│   ├── dag.ts         # DAG 核心实现
│   │   ├── MermaidParser      # Mermaid 解析器
│   │   ├── ExecutionPlanner   # 执行计划生成
│   │   └── WorkflowManager    # 工作流管理器
│   └── index.ts       # 工具定义
├── channel/           # 继承自 V11
├── security/          # 继承自 V12
├── evolution/         # 继承自 V13
├── multimodel/        # 继承自 V15
└── ...
```

## 新增工具 (6 个)

| 工具 | 描述 |
|------|------|
| `workflow_create` | 从 Mermaid 创建工作流 |
| `workflow_plan` | 获取执行计划 |
| `workflow_run` | 执行工作流 |
| `workflow_status` | 查看工作流状态 |
| `workflow_list` | 列出所有工作流 |
| `workflow_visualize` | 可视化工作流 |

## 使用示例

```typescript
// 创建工作流
const mermaid = `
flowchart TD
    A[获取数据] --> B[清洗数据]
    B --> C{数据有效?}
    C -->|yes| D[分析处理]
    C -->|no| E[错误报告]
`;

await tools.workflow_create({ name: "数据流程", mermaid });

// 查看执行计划
await tools.workflow_plan({ workflowId: "wf_xxx" });
// 输出: 阶段 1: A
//       阶段 2: B
//       阶段 3: C
//       阶段 4: D, E (并行)

// 执行
await tools.workflow_run({ workflowId: "wf_xxx" });
```

## 设计亮点

1. **声明式**: 用 Mermaid 描述，无需编程
2. **自动并行**: 智能识别可并行任务
3. **可视化**: ASCII 图形化展示
4. **渐进式**: 继承 V11-V15 所有能力

## 统计变化

| 指标 | V15 | V16 | 变化 |
|------|-----|-----|------|
| 代码行数 | 4945 | 6098 | +1153 |
| 工具数 | 64 | 70 | +6 |
| 模块数 | 9 | 10 | +1 |

---

*详见: [docs/v16-工作流引擎.md](../v16-工作流引擎.md)*
