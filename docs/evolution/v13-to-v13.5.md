# V13 -> V13.5: 上下文压缩系统

> 解决长对话的 token 消耗问题

## 核心变化

V13.5 引入 ContextCompressor，实现：
1. 自动压缩长对话历史
2. 智能保留重要消息
3. 工具输出自动截断
4. 历史摘要可追溯

## 新增代码量

- **新增行数**: ~380 行
- **新增工具**: 4 个
- **新增目录**: `.compression/`

## 新增工具

| 工具 | 描述 |
|------|------|
| `context_status` | 查看压缩状态 |
| `context_compress` | 手动压缩 |
| `context_config` | 配置参数 |
| `context_summary` | 查看摘要 |

## 关键代码

### ContextCompressor 类

```typescript
class ContextCompressor {
  private config: CompressionConfig;
  private summaries: ContextSummary[] = [];

  // 评估消息重要性
  private evaluateImportance(message: MessageParam): MessageImportance {
    let score = 0.5;
    if (message.role === 'user') score += 0.2;
    if (hasImportantKeywords(content)) score += 0.2;
    if (isToolResult(content)) score -= 0.2;
    return { score, reasons };
  }

  // 截断工具输出
  truncateToolOutput(output: string): string {
    if (output.length <= this.config.maxToolOutput) return output;
    const half = Math.floor(this.config.maxToolOutput / 2);
    return output.slice(0, half) + '\n...[截断]...\n' + output.slice(-half);
  }

  // 压缩历史
  compress(history: MessageParam[]): MessageParam[] {
    if (history.length <= this.config.keepRecent * 2) return history;
    
    const toCompress = history.slice(0, -this.config.keepRecent * 2);
    const toKeep = history.slice(-this.config.keepRecent * 2);
    
    const summary = this.generateSummary(toCompress);
    const important = toCompress.filter(m => 
      this.evaluateImportance(m).score >= this.config.importanceThreshold
    );
    
    return [summaryMessage, ...important.slice(-5), ...toKeep];
  }
}
```

### 自动压缩集成

```typescript
async function chat(prompt: string, history: MessageParam[] = []) {
  history.push({ role: "user", content: prompt });
  
  // V13.5: 自动压缩
  const compressed = contextCompressor.compress(history);
  if (compressed.length < history.length) {
    history.length = 0;
    history.push(...compressed);
    console.log(`[压缩] 上下文已压缩: ${history.length} 条消息`);
  }
  
  // ...
}
```

### 工具输出截断

```typescript
// 在工具执行后
output = contextCompressor.truncateToolOutput(output);
```

## 重要性评分规则

| 因素 | 分数变化 |
|------|----------|
| 用户消息 | +0.2 |
| 重要关键词 | +0.2 |
| 代码/命令 | +0.1 |
| 工具结果 | -0.2 |
| 内容过短 | -0.1 |
| 内容丰富 | +0.1 |

## 默认配置

```typescript
const DEFAULT_CONFIG = {
  maxTurns: 50,
  keepRecent: 10,
  maxToolOutput: 3000,
  summaryMaxChars: 500,
  autoCompress: true,
  importanceThreshold: 0.3
};
```

## 测试覆盖

新增 `tests/v13.5-compression.test.ts`:
- 配置测试 (2 tests)
- 重要性评分测试 (3 tests)
- 工具截断测试 (2 tests)
- 摘要生成测试 (2 tests)
- 压缩逻辑测试 (3 tests)
- 滑动窗口测试 (1 test)
- 统计追踪测试 (1 test)

**总测试数: 117 个 (全部通过)**

## 下一步

V14 可能的方向：
- 插件系统
- LLM 智能摘要
- 语义压缩

---

*Created: 2026-02-10*
