# V11 -> V12: 安全策略系统

## 核心变化

从「多渠道接入」到「安全策略管理」。

| 维度 | V11 | V12 |
|------|-----|-----|
| 核心能力 | Channel 系统 | Security 系统 |
| 新增行数 | ~2324 | ~2766 (+442) |
| 新增工具 | 6 | 5 |
| 安全模型 | 信任等级 | 完整策略+审计 |

## 新增组件

### 1. SecuritySystem 类

```typescript
class SecuritySystem {
  // 权限检查
  checkPermission(tool: string, args: Record<string, any>): { 
    allowed: boolean; 
    reason?: string; 
    needsConfirm?: boolean 
  };
  
  // 审计日志
  logAudit(entry: AuditLogEntry): void;
  getAuditLogs(days: number, limit: number): string;
  
  // 敏感数据保护
  maskSensitive(text: string): string;
  containsSensitive(text: string): boolean;
  
  // 策略管理
  getPolicySummary(): string;
  updatePolicy(updates: Partial<SecurityPolicy>): string;
  setToolRiskLevel(tool: string, level: ToolRiskLevel): string;
}
```

### 2. 工具风险分级

- **Safe**: 只读操作 (21个)
- **Confirm**: 写操作 (19个)
- **Dangerous**: 系统操作 (5个)

### 3. 审计日志系统

每次非 safe 操作都会记录到 `.security/audit/` 目录。

## 新增工具

| 工具 | 描述 |
|------|------|
| `security_check` | 检查操作是否允许 |
| `security_audit` | 查看审计日志 |
| `security_policy` | 查看/更新策略 |
| `security_mask` | 遮蔽敏感信息 |
| `security_context` | 设置安全上下文 |

## 安全增强

### 权限检查流程

```
工具调用 -> 获取风险等级 -> 检查信任等级 -> 检查���聊限制 -> 执行/拒绝
```

### 敏感数据模式

```typescript
sensitivePatterns: [
  /api[_-]?key/i,
  /password/i,
  /secret/i,
  /token/i,
  /private[_-]?key/i,
  /credential/i,
  /\b[A-Za-z0-9+/]{40,}\b/,  // Base64
  /sk-[a-zA-Z0-9]{20,}/,     // OpenAI
  /ghp_[a-zA-Z0-9]{36}/,     // GitHub
]
```

## 配置持久化

- 策略: `.security/policy.json`
- 审计: `.security/audit/audit_YYYY-MM-DD.jsonl`

## 设计原则

1. **最小权限**: 默认拒绝，显式允许
2. **分层防御**: 多重检查，逐层把关
3. **可审计**: 所有操作留痕
4. **可配置**: 策略可按需调整

## 下一步

V13 将实现自进化系统，基于内省和审计数据自动优化行为。

---

*Created: 2026-02-10*
