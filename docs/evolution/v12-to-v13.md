# V12 -> V13: 自进化系统

> 从被动响应到主动优化

## 核心变化

V13 引入 Evolution 系统，让 Agent 能够：
1. 分析自己的行为模式
2. 生成优化建议
3. 自动应用高置信度改进
4. 追踪进化历史

## 新增代码量

- **新增行数**: ~470 行
- **新增工具**: 5 个
- **新增目录**: `.evolution/`

## 新增工具

| 工具 | 描述 |
|------|------|
| `evolve_analyze` | 分析行为模式 |
| `evolve_suggest` | 生成优化建议 |
| `evolve_apply` | 应用优化建议 |
| `evolve_status` | 查看进化状态 |
| `evolve_history` | 查看进化历史 |

## 关键代码

### EvolutionSystem 类

```typescript
class EvolutionSystem {
  private patterns: ToolCallPattern[] = [];
  private suggestions: PolicySuggestion[] = [];

  // 分析行为模式
  analyze(days: number = 7): string {
    // 读取内省日志
    // 识别工具调用序列
    // 统计频率和成功率
    // 识别低效和错误模式
  }

  // 生成优化建议
  suggest(focus?: 'security' | 'performance' | 'all'): string {
    // 基于模式生成建议
    // 计算置信度
    // 提供证据支持
  }

  // 应用建议
  apply(suggestionId: string, confirm: boolean = false): string {
    // 检查置信度
    // 应用变更
    // 记录历史
  }
}
```

### 模式识别

```typescript
// 识别连续3个工具的调用序列
for (let i = 0; i < toolCalls.length - 2; i++) {
  const seq = [
    toolCalls[i].tool,
    toolCalls[i+1].tool,
    toolCalls[i+2].tool
  ].join(' -> ');
  sequences.set(seq, (sequences.get(seq) || 0) + 1);
}
```

### 建议生成

```typescript
interface PolicySuggestion {
  id: string;
  type: 'risk_level' | 'trust_adjustment' | 'deny_list' | 'performance';
  tool?: string;
  currentValue: string;
  suggestedValue: string;
  confidence: number;  // 0-1
  reason: string;
  evidence: string[];
}
```

## 系统提示更新

```diff
- observe -> route -> heartbeat -> recall -> identify -> plan -> execute -> track -> remember -> reflect
+ observe -> route -> heartbeat -> recall -> identify -> plan -> execute -> track -> remember -> reflect -> evolve
```

新增自进化系统描述：

```
## 自进化系统 (V13 核心)
工具: evolve_analyze, evolve_suggest, evolve_apply, evolve_status, evolve_history
- 分析行为模式: 从内省日志识别工具调用模式
- 生成优化建议: 基于数据提出安全和性能改进
- 应用建议: 高置信度建议可自动应用
- 追踪进化: 记录所有优化决策和效果
```

## 数据流

```
内省日志 (.introspection/)
        ↓
    行为分析
        ↓
    模式识别
        ↓
    建议生成
        ↓
    人工/自动应用
        ↓
    历史记录 (.evolution/history.jsonl)
```

## 与现有系统集成

### V10 内省系统
- 读取内省日志作为数据源
- 分析工具调用模式和耗时

### V12 安全系统
- 读取审计日志
- 生成安全策略调整建议

## 设计原则

1. **数据驱动**: 所有建议基于实际使用数据
2. **保守应用**: 置信度 < 70% 需要确认
3. **可回滚**: 所有变更可撤销
4. **透明追踪**: 记录所有进化决策

## 测试覆盖

新增 `tests/v13-evolution.test.ts`:
- 行为分析测试
- 策略建议测试
- 进化历史测试
- 模式存储测试
- 安全系统集成测试
- 自修复测试

## 下一步

V14 可能的方向：
- 插件系统 - 动态加载外部能力
- 多模型协作 - 不同任务使用���同模型

---

*Created: 2026-02-10*
