# V13.5 → V14 演进指南

## 概述

V14 在 V13.5 的基础上增加了 **插件系统**，实现能力的模块化和动态加载。

## 新增能力

### 插件系统

| 工具 | 描述 |
|------|------|
| `plugin_list` | 列出所有已加载插件 |
| `plugin_load` | 加载插件 |
| `plugin_unload` | 卸载插件 |
| `plugin_config` | 查看/更新插件配置 |
| `plugin_info` | 查看插件详情 |

### 内置插件

- **weather**: 获取天气信息 (模拟)
- **calculator**: 数学计算
- **timestamp**: 时间戳转换

## 核心变更

### 1. 插件接口

```typescript
interface Plugin {
  id: string;
  name: string;
  version: string;
  description?: string;
  author?: string;
  
  configSchema?: PluginConfigSchema;
  tools?: PluginTool[];
  hooks?: PluginHook[];
  
  onLoad?: (ctx: PluginContext) => Promise<void> | void;
  onUnload?: () => Promise<void> | void;
}
```

### 2. 插件工具

```typescript
interface PluginTool {
  name: string;
  description: string;
  inputSchema: Record<string, unknown>;
  handler: (args: Record<string, unknown>, ctx: PluginToolContext) => Promise<string> | string;
}
```

### 3. 生命周期钩子

支持的钩子:
- `before_agent_start`
- `after_agent_end`
- `before_tool_call`
- `after_tool_call`
- `message_received`
- `message_sending`

## 代码统计

| 指标 | V13.5 | V14 | 变化 |
|------|-------|-----|------|
| 代码行数 | 3619 | 4311 | +692 |
| 工具数量 | 59 | 64 | +5 |
| 测试数量 | 117 | 131 | +14 |

## 迁移步骤

1. 复制 v13.5-agent.ts 为 v14-agent.ts
2. 添加 PluginManager 类 (~600 行)
3. 添加 5 个插件工具定义
4. 更新工具执行逻辑支持插件工具
5. 更新系统提示

## 使用示例

### 加载内置插件

```
>> 加载 calculator 插件
[plugin_load] {"source": "calculator"}
已加载插件: Calculator Plugin v1.0.0

>> 计算 2 + 3 * 4
[plugin_calc] {"expression": "2 + 3 * 4"}
2 + 3 * 4 = 14
```

### 查看插件信息

```
>> 查看 calculator 插件详情
[plugin_info] {"plugin_id": "calculator"}

## Calculator Plugin

- **ID**: calculator
- **版本**: 1.0.0
- **描述**: 数学计算

### 提供的工具
- **plugin_calc**: 执行数学计算
```

## 设计决策

1. **内置插件优先**: 提供常用功能的内置实现
2. **配置持久化**: 插件配置保���到 .plugins.json
3. **工具命名空间**: 插件工具以 `plugin_` 前缀区分
4. **安全沙箱**: 插件代码在受限环境运行 (待完善)

## 下一步

V15 计划: 多模型协作
- 模型路由策略
- 成本优化
- 能力匹配
