# V10 -> V11: Channel 系统

## 核心变化

从「自我观察」到「多渠道接入」。

| 维度 | V10 | V11 |
|------|-----|-----|
| 核心能力 | 内省系统 | Channel 系统 |
| 新增行数 | ~1782 | ~2324 (+542) |
| 新增工具 | 4 | 6 |
| 交互方式 | 单一 REPL | 多渠道 |

## 新增组件

### 1. Channel 接口

```typescript
interface Channel {
  id: string;
  name: string;
  capabilities: ChannelCapabilities;
  
  start(): Promise<void>;
  stop(): Promise<void>;
  isRunning(): boolean;
  
  send(target: string, message: string): Promise<void>;
  onMessage(handler: (ctx: MessageContext) => Promise<void>): void;
  
  getTrustLevel(userId: string): TrustLevel;
  setTrustLevel(userId: string, level: TrustLevel): void;
}
```

### 2. ChannelManager

统一管理所有渠道的注册、启动、停止和消息路由。

### 3. 内置渠道

- **ConsoleChannel**: 测试用，模拟消息收发
- **TelegramChannel**: Telegram Bot 骨架
- **DiscordChannel**: Discord Bot 骨架

## 新增工具

| 工具 | 描述 |
|------|------|
| `channel_list` | 列出所有渠道 |
| `channel_send` | 发送消息到指定渠道 |
| `channel_status` | 查看渠道状态 |
| `channel_config` | 配置渠道参数 |
| `channel_start` | 启动所有已启用渠道 |
| `channel_stop` | 停止所有渠道 |

## 安全增强

### 用户信任等级

```typescript
type TrustLevel = 'owner' | 'trusted' | 'normal' | 'restricted';
```

### 渠道策略

- **groupPolicy**: 群组消息处理策略
- **dmPolicy**: 私聊消息处理策略
- **trustedUsers**: 信任用户白名单

## 配置持久化

渠道配置保存在 `.channels.json`:

```json
{
  "telegram": {
    "enabled": true,
    "groupPolicy": "mention-only",
    "trustedUsers": ["user123"]
  }
}
```

## 设计原则

1. **渠道即插件**: 实现 Channel 接口即可添加新渠道
2. **消息路由**: 根据来源自动选择响应渠道
3. **权限分层**: 不同用户不同权限
4. **安全隔离**: 敏感信息不跨渠道泄露

## 下一步

V12 将实现完整的安全策略系统，包括：
- 工具级别的权限控制
- 审计日志
- 敏感数据自动遮蔽

---

*Created: 2026-02-10*
