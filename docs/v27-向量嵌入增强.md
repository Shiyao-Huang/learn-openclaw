# V27: 向量嵌入增强

> 让 Agent 拥有语义理解和搜索能力

## 概述

V27 在 V26 Canvas 显示系统的基础上，新增了向量嵌入能力。这使得 Agent 能够：

- 将文本转换为高维向量表示
- 进行语义相似度搜索
- 索引和检索大量文本内容
- 计算文本之间的相似度

## 架构

```
v27-agent/
├── embedding/
│   ├── types.ts          # 类型定义
│   ├── engine.ts         # 嵌入引擎核心
│   ├── providers.ts      # 提供者实现 (OpenAI, Local)
│   ├── vector-store.ts   # 向量存储 (Memory, SQLite)
│   ├── tools.ts          # 10 个工具定义
│   ├── handlers.ts       # 工具处理器
│   └── index.ts          # 模块入口
└── index.ts              # 主入口
```

## 工具列表

| 工具名 | 描述 |
|--------|------|
| `embedding_embed` | 将文本转换为向量嵌入 |
| `embedding_search` | 在已索引内容中搜索相似文本 |
| `embedding_index` | 将内容索引到向量存储 |
| `embedding_status` | 获取嵌入系统状态 |
| `embedding_clear` | 清除向量存储和缓存 |
| `embedding_similarity` | 计算两个文本的语义相似度 |
| `embedding_batch_embed` | 批量嵌入多个文本 |
| `embedding_get` | 根据 ID 获取向量条目 |
| `embedding_delete` | 根据 ID 删除向量条目 |
| `embedding_list_providers` | 列出可用的嵌入提供者 |

## 提供者

### OpenAI Embeddings (云端)

- **模型**: `text-embedding-3-small` (默认), `text-embedding-3-large`, `text-embedding-ada-002`
- **维度**: 1536 / 3072 / 1536
- **需要**: `OPENAI_API_KEY` 环境变量

```typescript
const engine = new EmbeddingEngine({
  provider: {
    type: "openai",
    apiKey: process.env.OPENAI_API_KEY,
    model: "text-embedding-3-small",
  },
  store: { type: "memory" },
});
```

### Local Jaccard (本地)

- **模型**: `jaccard-v1`
- **维度**: 128 (虚拟向量)
- **无需**: API Key

本地提供者使用 Jaccard 相似度，基于 token 重叠计算相似性。适合无网络环境或快速原型开发。

```typescript
const engine = new EmbeddingEngine({
  provider: {
    type: "local",
  },
  store: { type: "memory" },
});
```

### 自动选择

默认使用 `auto` 模式：

1. 优先尝试 OpenAI (需要 API Key)
2. 降级到 Local Jaccard

## 向量存储

### 内存存储 (默认)

```typescript
const store = createVectorStore({
  type: "memory",
});
```

- 速度快
- 重启后丢失
- 适合测试和小规模数据

### SQLite 存储

```typescript
const store = createVectorStore({
  type: "sqlite",
  path: "./data/vectors.db",
});
```

- 持久化存储
- 适合生产环境

## 使用示例

### 嵌入文本

```typescript
const result = await engine.embedText({
  text: "这是一段需要嵌入的文本",
  useCache: true,
});

console.log(result.dimensions); // 1536 (OpenAI) 或 128 (Local)
console.log(result.cached); // 是否来自缓存
```

### 索引内容

```typescript
const result = await engine.indexContent({
  content: "长文本内容...",
  source: "document.txt",
  chunkSize: 500,
  chunkOverlap: 50,
});

console.log(result.chunks); // 分块数量
console.log(result.entries); // 条目 ID 列表
```

### 语义搜索

```typescript
const result = await engine.searchVectors({
  query: "搜索查询",
  topK: 5,
  minScore: 0.7,
  source: "document.txt",
});

for (const r of result.results) {
  console.log(r.score, r.content);
}
```

### 计算相似度

```typescript
const result = await engine.searchVectors({
  query: "搜索查询",
  topK: 5,
});

// 相似度分数范围: 0-1
// 0.8+ : 高度相似
// 0.5-0.8 : 中等相似
// 0.2-0.5 : 略微相似
// <0.2 : 不相似
```

## 缓存机制

嵌入结果会被缓存以提高性能：

- **最大条目**: 1000 (可配置)
- **过期时间**: 1 小时 (可配置)
- **Hash 算法**: 简单文本 hash

```typescript
const config = {
  cache: {
    enabled: true,
    maxSize: 1000,
    ttlMs: 3600000, // 1 hour
  },
};
```

## 批处理

启用批处理可以提高大量嵌入的效率：

```typescript
const config = {
  batch: {
    enabled: true,
    maxSize: 100,
    concurrency: 5,
    timeoutMs: 30000,
  },
};
```

## 性能考虑

| 提供者 | 速度 | 质量 | 成本 |
|--------|------|------|------|
| OpenAI | 中 | 高 | $0.02/1M tokens |
| Local Jaccard | 快 | 中 | 免费 |

## 依赖

- 无额外依赖 (仅使用标准 fetch API)
- 可选: better-sqlite3 (SQLite 存储)

## 继承

V27 继承 V26 的所有能力：

- Canvas 显示系统 (9 个工具)
- STT 语音识别 (5 个工具)
- TTS 语音能力 (6 个工具)
- Vision 图像理解 (5 个工具)
- Sandbox 代码执行 (5 个工具)
- Cron 定时任务 (6 个工具)
- ... 以及 V11-V20 的所有能力

**工具总数**: 153 个

---

*V27 向量嵌入增强 - 2026-02-14*
