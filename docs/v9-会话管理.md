# V9: 会话管理系统

> 核心哲学: 隔离上下文，才能同时处理多任务而不污染记忆。

V9 在 V8 基础上新增 `SessionManager`，把会话变成可持久化、可清理、可路由的对象。

---

## V8 vs V9

| 维度 | V8 | V9 |
|---|---|---|
| 工具数 | 31 | 35 |
| 新增工具 | - | `session_create/list/delete/cleanup` |
| 新目录 | - | `.sessions/` |
| 代码规模 | 1662 行 | 1527 行 |

---

## Session 模型

```typescript
type SessionType = "main" | "isolated";

interface Session {
  key: string;
  type: SessionType;
  history: Anthropic.MessageParam[];
  createdAt: number;
  lastActiveAt: number;
  metadata: Record<string, any>;
}
```

---

## SessionManager 关键能力

- 启动时从 `.sessions/*.json` 自动加载
- 每次保存只保留最近 20 条消息（防止文件膨胀）
- `lastActiveAt` 用于会话排序和过期清理
- 过期清理阈值: 7 天

---

## 4 个 session 工具（代码实际）

```typescript
session_create(type?, metadata?)
session_list()
session_delete(key)
session_cleanup()
```

说明：V9 当前并未暴露 `session_get` 工具。

> 代码里 `BASE_SYSTEM` 文案仍提到 `session_get`，属于提示文案与工具注册未完全同步；以 `TOOLS` 和 `switch case` 实际实现为准。

---

## 会话类型策略

### `main`

- 主会话
- 承载长期持续任务
- 通常默认创建

### `isolated`

- 隔离会话
- 用于临时任务/外部请求
- 适合减少上下文串扰

---

## 典型流程

```text
请求到达
  -> session_create(type=main|isolated)
  -> 在该会话内执行完整 agent loop
  -> updateHistory + saveSession
  -> 定期 session_cleanup
```

---

## 最小验证

```bash
npx tsx v9-agent.ts
```

```text
>> 创建一个隔离会话
[session_create] {"type":"isolated","metadata":{"source":"temp-task"}}

>> 列出会话
[session_list] {}

>> 删除某个会话
[session_delete] {"key":"session_..."}

>> 清理 7 天前会话
[session_cleanup] {}
```

---

## 演进意义

V9 让“工具、记忆、身份、心跳”第一次具备了多上下文并行承载能力，是从单会话 Agent 向多任务 Agent 的关键跃迁。

---

[← V8: 心跳系统](./v8-心跳系统.md) | [返回演进总览](./EVOLUTION.md)
